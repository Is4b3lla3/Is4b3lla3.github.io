<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ThinkPHP6，漏洞分析"><meta name="keywords" content="ThinkPHP6"><meta name="author" content="Zhangcs"><meta name="copyright" content="Zhangcs"><title>ThinkPHP6任意文件操作漏洞分析 | Isabellae's Blog</title><link rel="shortcut icon" href="/terminal_emulator.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#环境准备"><span class="toc-number">1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#本地环境复现"><span class="toc-number">3.</span> <span class="toc-text">本地环境复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#总结："><span class="toc-number">3.1.</span> <span class="toc-text">总结：</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/IMG_20190204_224358.jpg"></div><div class="author-info__name text-center">Zhangcs</div><div class="author-info__description text-center">Sec researcher</div><div class="follow-button"><a href="https://github.com/zhangchensong" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">5</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">3</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">3</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="http://www.y1nhui.com/" target="_blank" rel="noopener">y1nhui</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/2700d379fda645e77d754fc4956024c6.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Isabellae's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">ThinkPHP6任意文件操作漏洞分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>这个洞出来也有一段时间了，看了创宇的paper后觉得蛮简单的，决定自己在本地搭建复现一下，记录一下学习的过程。</p>
<a id="more"></a>


<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><p>apache + thinphp(&lt;=6.0.0版本&lt;=6.0.2) + php7以上</p>
<ul>
<li>ThinkPHP6起只能使用composer来安装，安装composer、php、apache的过程我就不赘述了。<br>执行命令:<code>composer create-project topthink/think tp 6.0.0</code>，其中tp是你的文件夹命名，6.0.0是版本号，6.0.1也可。<br>这里说一个问题，我这个时间Thinkphp的最新版是6.0.2，用上面的命令下载下来framework是6.0.2版本的，我们需要再执行一条命令：<code>composer require topthink/framework:6.0.0</code>：此时就会把将6.0.0的版本把6.0.2给替换掉</li>
<li>进入tp的安装目录，执行<code>php think run</code>，它会开启一个临时的开发环境的服务器，默认运行在<code>localhost:8000</code>，打开浏览器访问显示正常即可<blockquote>
<p>漏洞复现在apache下进行</p>
</blockquote>
</li>
</ul>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>漏洞影响的版本：top-think/framework 6.x &lt; 6.0.2</p>
<ul>
<li>官方信息<br>ThinkPHP发布的补丁声称修复了一处由于不安全的SessionId导致的任意文件操作漏洞：在开启Session的情况下可以导致创建任意文件以及删除任意文件，特定情况下可以getshell</li>
<li>根据这些信息，我们到官方GitHub的commit页面找一下相关的提交记录：<br><img src="github.png" alt="github"></li>
</ul>
<p>可以看到位于src/think/session/Store.php中212行在设置<code>id</code>时增加了一个函数：<code>ctype_alnum($text)</code>。<br>查一下PHP官方手册，这个函数是用来检测输入的<code>$text</code>中所有的字符全部是字母和(或者)数字，返回 TRUE 否则返回FALSE<br><img src="ctype_alnum.png" alt="ctype_alnum"></p>
<p>根据文件目录和更改的函数部分猜测：可能是存储Session时导致的文件写入；然后跟进找一下相关的函数，可以看到<code>vendor/topthink/framework/src/think/session/Store.php:254</code>的save()函数，265行还可以对文件进行删除操作，并且对后端业务逻辑依赖较低<br><img src="save.png" alt="save"></p>
<p>可以看到设置了$sessionId，并且调用了一个write函数，继续跟进，找到write()函数<code>vendor/topthink/framework/src/think/session/driver/File.php:210</code><br><img src="write.png" alt="write"></p>
<p>继续跟进，找到writeFile()函数<br><img src="writeFile.png" alt="writeFile"></p>
<p>可以看到调用了<code>file_put_contents()</code>函数，这里是真正写入文件的操作了<br><img src="file_put_contents.png" alt="file_put_contents"></p>
<ul>
<li>接下来我们反向分析一下，看看能不能找到可控点</li>
</ul>
<ol>
<li>函数<code>file_put_contents($path,$content,LOCK_EX)</code>中参数<code>$path,$content</code>来源于函数<code>writeFile($path,$data)</code></li>
<li>函数<code>writeFile($path,$data)</code>中参数<code>$path,$data</code>来源于函数<code>write(String $sessionID,String $sessiData)</code></li>
<li>函数<code>write(String $sessionID,String $sessiData)</code>中参数<code>$sessionID,$sessiData</code>来源于<code>save()</code>中调用了<code>write()</code>，同时传入的参数<code>$sessionId</code>的值是调用<code>getId()</code>传入的<br>综上：文件名来源于<code>$sessionId</code></li>
</ol>
<ul>
<li><p>当传入的id值长度为32并且……etc时，创建<code>sessionId</code>，然后进行<code>gitId()</code><br><img src="session.png" alt="session"></p>
</li>
<li><p>接下来找调用<code>setId()</code>的地方<code>vendor/topthink/framework/src/think/middleware/SessionInit.php:46</code><br><img src="sessionI.png" alt="sessionI"><br>其中<code>cookieName</code>的值为<code>PHPSESSID</code>，而<code>$sessionId</code>是<code>cookie</code>中名为<code>PHPSESSID</code>的值，因此是攻击者可控的，从而导致写入的文件名可控。<br>但是默认环境下，<code>session</code>的内容由<code>vendor/topthink/framework/src/think/session/Store.php:261</code>的变量<code>$data</code>传入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br></pre></td></tr></table></figure>
<p><code>$data</code>在默认环境中为空：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Session数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> $data = [];</span><br></pre></td></tr></table></figure>
<p>写入的<code>session</code>内容是由实际的后端业务逻辑来决定的，所以说只有苛刻的条件下才能写入webshell。并且一开始就说了需要在环境开启<code>session</code>的情况下才可以实现任意文件操作(默认环境不开启session)</p>
</li>
<li><p>我们在<code>app\controller\index.php</code>中增加一些代码后，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">facade</span>\<span class="title">Session</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Session::set(<span class="string">'name'</span>,<span class="string">'thinkphp'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;style type="text/css"&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: "Century Gothic","Microsoft yahei"; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style="padding: 24px 48px;"&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V6&lt;br/&gt;&lt;span style="font-size:30px"&gt;13载初心不改 - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type="text/javascript" src="https://tajs.qq.com/stats?sId=64890268" charset="UTF-8"&gt;&lt;/script&gt;&lt;script type="text/javascript" src="https://e.topthink.com/Public/static/client.js"&gt;&lt;/script&gt;&lt;think id="eab4b9f840753f8e7"&gt;&lt;/think&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span><span class="params">($name = <span class="string">'ThinkPHP6'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'hello,'</span> . $name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<blockquote>
<p>忘了说了thinkphp6开启session的方法：删除<code>/app/middleware.php</code>最后一行的注释<br><img src="kq.png" alt="kq"></p>
</blockquote>
<h1 id="本地环境复现"><a href="#本地环境复现" class="headerlink" title="本地环境复现"></a>本地环境复现</h1><p>很简单，只需要构造PHPSESSID的值即可，值为<code>string</code>&amp;&amp;长度为32<br><img src="tp.png" alt="tp"><br>此时查看一下生成的session，生成的session文件保存在<code>\runtime\session</code>下<br><img src="sessionphp.png" alt="sessionphp"><br>session里的内容:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:4:"name";s:8:"thinkphp";&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到session的内容经过了序列化操作，只要将session的内容反序列化即可getshell</p>
<ul>
<li>如果要getshell的话，后端需要有类似的<code>Session::Set(&#39;name&#39;,$_POST[&#39;i&#39;])</code>代码才可以利用</li>
</ul>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>在复现的过程，也遇到了不少问题：首先ThinkPHP6开始不支持git了，只能通过composer来操作，由于从来没用过它也没经验，一开始安装环境一直下载不到旧版本，后来得到师傅的帮助终于下好了ThinkPHP6.0.0的环境，在这里感谢一下师傅<a href="https://weibo.com/u/5332465356" target="_blank" rel="noopener">@P1an0</a>对我的帮助。<br>这个漏洞其实很简单，就是用户可控变量导致的，也没有对一些数据的过滤等等。需要一定条件才可以利用，也就是开启session；写webshell还要看具体的后端业务逻辑等等。我觉得就这个框架来看其实可以更深入的进行挖掘，希望有大佬可以和我一起探讨学习</p>
<p>参考的paper：<a href="https://paper.seebug.org/1114/" target="_blank" rel="noopener">ThinkPHP6 任意文件操作漏洞分析</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Zhangcs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://is4b3lla3.github.io/2020/01/26/ThinkPHP6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0/">http://is4b3lla3.github.io/2020/01/26/ThinkPHP6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ThinkPHP6/">ThinkPHP6</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/01/31/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%9C%A8wamper64%E4%B8%AD%E5%A2%9E%E5%8A%A0php%E7%89%88%E6%9C%AC%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91/"><i class="fa fa-chevron-left">  </i><span>记一次在wamper64中增加php遇到的问题</span></a></div><div class="next-post pull-right"><a href="/2019/11/25/%E5%85%B3%E4%BA%8Esql%E6%B3%A8%E5%85%A5/"><span>关于sql注入</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/2700d379fda645e77d754fc4956024c6.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Zhangcs</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>